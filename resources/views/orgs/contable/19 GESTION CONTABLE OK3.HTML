
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Gestión Contable</title>

  <!-- Favicons -->
  <link href="https://hydrosite.cl/public/theme/common/img/favicon.png" rel="icon">
  <link href="https://hydrosite.cl/public/theme/common/img/apple-touch-icon.png" rel="apple-touch-icon">

  <!-- Google Fonts -->
  <link href="https://fonts.gstatic.com" rel="preconnect">
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700|Nunito:300,400,600,700|Poppins:300,400,500,600,700" rel="stylesheet">

  <!-- Vendor CSS Files -->
  <link href="https://hydrosite.cl/public/theme/nice/assets/vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css" rel="stylesheet">
  <link href="https://hydrosite.cl/public/theme/nice/assets/vendor/boxicons/css/boxicons.min.css" rel="stylesheet">
  
  <!-- Chart.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- SheetJS para exportar a Excel -->
  <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>

  <style>
    /* Estilos CSS completos del código original */
    /* Se mantienen todos los estilos visuales originales */
    :root {
      --primary-color: #2c5282;
      --secondary-color: #4CAF50;
      --danger-color: #e53e3e;
      --success-color: #48bb78;
      --warning-color: #dd6b20;
      --purple-color: #805ad5;
      --orange-color: #dd6b20;
      --light-bg: #f8f9fa;
    }

    /* ESTILO NUEVO PARA EL BOTÓN INFORMES POR RUBRO */
    .btn-wrapper button:nth-child(7) {
      background: linear-gradient(120deg, #9c27b0, #e91e63);
    }
    
    .btn-wrapper button:nth-child(7):hover {
      box-shadow: 0 6px 15px rgba(156, 39, 176, 0.3);
    }
    
    /* Mejoras para PDF */
    @media print {
      body {
        background: white !important;
        padding: 0 !important;
      }
      
      .card, .table-container, .rubro-container {
        box-shadow: none !important;
        border: 1px solid #ddd !important;
      }
      
      .button-group {
        display: none !important;
      }
      
      .modal {
        display: none !important;
      }
    }

    /* ESTILO NUEVO PARA EL BOTÓN REGISTRO DE MOVIMIENTOS */
.btn-wrapper button:nth-child(8) {
  background: linear-gradient(120deg, #805ad5, #6b46c1);
}

.btn-wrapper button:nth-child(8):hover {
  box-shadow: 0 6px 15px rgba(128, 90, 213, 0.3);
}

    /* Modales - Estilos base */
    .modal {
      display: none;
      position: fixed;
      z-index: 1050;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      overflow: hidden;
      padding: 10px 0;
    }
    
    .modal.show {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background-color: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
      transform: scale(0.95);
      transition: transform 0.3s ease;
      
      /* Permitir redimensionamiento manual */
      resize: both;
      overflow: auto;
      
      /* Dimensiones iniciales */
      min-width: 320px;
      max-width: 90vw;
      min-height: 300px;
      max-height: 90vh;
      
      /* Para el contenedor interno */
      display: flex;
      flex-direction: column;
    }
    
    .modal.show .modal-content {
      transform: scale(1);
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
      position: relative;
    }
    
    .modal-header h2 {
      color: var(--primary-color);
      font-size: 1.8rem;
      font-weight: 600;
      max-width: 80%;
    }
    
    .modal-close {
      background-color: var(--danger-color);
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.3s ease;
      font-weight: 500;
    }
    
    .modal-close:hover {
      background-color: #c53030;
    }
    
    /* Formulario dentro del modal */
    .modal-form {
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 0; /* Importante para el redimensionamiento */
      overflow: auto;
    }
    
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: #2d3748;
    }
    
    input, select, textarea {
      width: 100%;
      padding: 14px;
      margin-bottom: 20px;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      background-color: #f8fafc;
      transition: all 0.3s ease;
      font-size: 16px;
    }
    
    input:focus, select:focus, textarea:focus {
      border-color: var(--primary-color);
      background-color: #fff;
      box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.2);
      outline: none;
    }
    
    textarea {
      resize: vertical;
      min-height: 100px;
    }
    
    button.submit-btn {
      background: linear-gradient(120deg, var(--secondary-color), #388e3c);
      color: white;
      padding: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      transition: all 0.3s ease;
      font-size: 18px;
      font-weight: 600;
      margin-top: auto; /* Para que se mantenga abajo */
    }
    
    button.submit-btn:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }
    
    /* Estilos para la vista horizontal en escritorio */
    @media (min-width: 768px) {
      .modal-form {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        grid-auto-rows: min-content;
        overflow: auto;
      }
      
      .modal-form > :nth-last-child(-n+4),
      .modal-form > textarea {
        grid-column: span 2;
      }
      
      .modal-form .submit-btn {
        grid-column: span 2;
        margin-top: 20px;
      }
      
      .modal-content {
        min-width: 600px;
        max-width: 90vw;
      }
    }
    
    /* Optimización para pantallas pequeñas */
    @media (max-width: 767px) {
      .modal-content {
        width: 95%;
        padding: 20px;
      }
      
      .modal-header h2 {
        font-size: 1.4rem;
      }
      
      .modal-form > * {
        width: 100%;
        margin-bottom: 15px;
      }
      
      /* Desactivar redimensionamiento en móviles */
      .modal-content {
        resize: none;
        max-height: 90vh;
      }
    }
    
    /* Indicador de redimensionamiento */
    .resize-handle {
      position: absolute;
      right: 5px;
      bottom: 5px;
      width: 20px;
      height: 20px;
      cursor: se-resize;
      background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%232c5282'%3E%3Cpath d='M22 22H10V20H20V10H22V22Z'/%3E%3C/svg%3E") no-repeat center;
      opacity: 0.5;
      transition: opacity 0.2s;
    }
    
    .modal-content:hover .resize-handle {
      opacity: 1;
    }
    
    /* Título principal */
    h1 {
      text-align: center;
      margin: 0 0 40px;
      color: var(--primary-color);
      font-size: 2.5rem;
      text-shadow: none;
      position: relative;
      padding-bottom: 15px;
    }
    
    h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 4px;
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      border-radius: 2px;
    }
    
    /* Instrucciones */
    .instructions {
      text-align: center;
      margin: 20px 0 40px;
      color: #4a5568;
      font-size: 1.1rem;
      max-width: 800px;
      margin: 0 auto 40px;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #f8f9fa, #eef2f7);
      min-height: 100vh;
      padding: 20px;
      color: #333;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    .card {
      background: white;
      border-radius: 12px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
      overflow: hidden;
      margin-bottom: 25px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.12);
    }
    
    .card-header {
      background: linear-gradient(120deg, var(--primary-color), #1a365d);
      color: white;
      padding: 20px 25px;
      font-size: 1.4rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .card-body {
      padding: 25px;
    }
    
    /* Estilos para la vista de registro */
    .registro-section {
      display: block;
    }
    
    .btn-wrapper {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      max-width: 900px;
      margin: 0 auto 30px;
    }
    
    .btn-wrapper button {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      border: none;
      border-radius: 10px;
      color: white;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-weight: 500;
    }
    
    .btn-wrapper button:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
    }
    
    .btn-wrapper button:nth-child(1) {
      background: linear-gradient(120deg, var(--secondary-color), #388e3c);
    }
    
    .btn-wrapper button:nth-child(2) {
      background: linear-gradient(120deg, var(--orange-color), #e65100);
    }
    
    .btn-wrapper button:nth-child(3) {
      background: linear-gradient(120deg, var(--primary-color), #1a365d);
    }
    
    .btn-wrapper button:nth-child(4) {
      background: linear-gradient(120deg, var(--purple-color), #6b46c1);
    }
    
    /* Botones adicionales con colores específicos */
    .btn-wrapper button:nth-child(5) {
      background: linear-gradient(120deg, var(--warning-color), #e65100);
    }
    
    .btn-wrapper button:nth-child(6) {
      background: linear-gradient(120deg, #0c94c9, #0a7ea8);
    }
    
    /* Estilos para la vista de libro de caja */
    .libro-caja-section, .balance-section, .conciliacion-section, .movimientos-section {
      display: none;
    }
    
    .section-header {
      text-align: center;
      margin: 20px 0 40px;
    }
    
    .section-header h1 {
      color: var(--primary-color);
      font-size: 2.5rem;
      margin-bottom: 10px;
      position: relative;
      display: inline-block;
      padding-bottom: 15px;
    }
    
    .section-header h1::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 150px;
      height: 4px;
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      border-radius: 2px;
    }
    
    .section-header p {
      color: #4a5568;
      font-size: 1.1rem;
      max-width: 800px;
      margin: 0 auto;
    }
    
    .saldo-section {
      background: linear-gradient(135deg, #2c5282, #1a365d);
      border-radius: 12px;
      padding: 25px;
      color: white;
      margin-bottom: 30px;
      box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
    }
    
    .saldo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    
    .saldo-item {
      background: rgba(255, 255, 255, 0.15);
      padding: 20px;
      border-radius: 10px;
      backdrop-filter: blur(5px);
    }
    
    .saldo-item label {
      color: #ebf8ff;
      font-size: 1rem;
      margin-bottom: 8px;
    }
    
    .saldo-item input {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      font-size: 1.4rem;
      font-weight: 600;
      padding: 12px;
    }
    
    .saldo-item input:focus {
      background: rgba(255, 255, 255, 0.3);
      box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.2);
    }
    
    .saldo-item input[readonly] {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .totals-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .total-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      text-align: center;
      transition: transform 0.3s ease;
    }
    
    .total-card:hover {
      transform: translateY(-5px);
    }
    
    .total-card.ingresos {
      border-top: 5px solid var(--success-color);
    }
    
    .total-card.egresos {
      border-top: 5px solid var(--danger-color);
    }
    
    .total-card.saldo {
      border-top: 5px solid var(--primary-color);
    }
    
    .total-card h3 {
      font-size: 1.2rem;
      color: #4a5568;
      margin-bottom: 15px;
    }
    
    .total-card .value {
      font-size: 2.2rem;
      font-weight: 700;
    }
    
    .total-card.ingresos .value {
      color: var(--success-color);
    }
    
    .total-card.egresos .value {
      color: var(--danger-color);
    }
    
    .total-card.saldo .value {
      color: var(--primary-color);
    }
    
    .table-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      overflow-x: auto;
      margin-bottom: 30px;
    }
    
    .table-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .table-header h2 {
      color: var(--primary-color);
      font-size: 1.6rem;
      font-weight: 600;
    }
    
    .filters {
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .filter-group {
      display: flex;
      flex-direction: column;
    }
    
    .filter-group label {
      font-size: 0.9rem;
      margin-bottom: 5px;
      color: #4a5568;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 1000px;
    }
    
    thead {
      background: linear-gradient(120deg, var(--primary-color), #1a365d);
      color: white;
    }
    
    th {
      padding: 16px 12px;
      text-align: center;
      font-weight: 600;
      border: 1px solid #2c5282;
    }
    
    .ingresos-header {
      background: #2c5282;
    }
    
    .egresos-header {
      background: #1a365d;
    }
    
    tbody tr {
      border-bottom: 1px solid #e2e8f0;
      transition: background-color 0.2s;
    }
    
    tbody tr:nth-child(even) {
      background-color: #f8fafc;
    }
    
    tbody tr:hover {
      background-color: #ebf8ff;
    }
    
    td {
      padding: 14px 10px;
      text-align: center;
      border: 1px solid #e2e8f0;
      font-size: 14px;
    }
    
    .ingreso-cell {
      background-color: #f0fff4;
      color: #2f855a;
      font-weight: 500;
    }
    
    .egreso-cell {
      background-color: #fff5f5;
      color: #c53030;
      font-weight: 500;
    }
    
    .button-group {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    
    .action-button {
      padding: 14px 30px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .action-button.volver {
      background: linear-gradient(120deg, #718096, #4a5568);
      color: white;
    }
    
    .action-button.pdf {
      background: linear-gradient(120deg, #e53e3e, #c53030);
      color: white;
    }
    
    .action-button.excel {
      background: linear-gradient(120deg, #2e7d32, #1b5e20);
      color: white;
    }
    
    .action-button:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
    }
    
    .action-button.volver:hover {
      box-shadow: 0 5px 15px rgba(113, 128, 150, 0.3);
    }
    
    .action-button.pdf:hover {
      box-shadow: 0 5px 15px rgba(229, 62, 62, 0.3);
    }
    
    .action-button.excel:hover {
      box-shadow: 0 5px 15px rgba(46, 125, 50, 0.3);
    }
    
    /* Estilos para la vista de Balance */
    .balance-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .balance-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease;
    }
    
    .balance-card:hover {
      transform: translateY(-5px);
    }
    
    .balance-card h3 {
      font-size: 1.3rem;
      color: var(--primary-color);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .balance-card ul {
      list-style: none;
      padding: 0;
    }
    
    .balance-card li {
      padding: 12px 0;
      border-bottom: 1px solid #edf2f7;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .balance-card li:last-child {
      border-bottom: none;
    }
    
    .balance-card .category {
      font-weight: 500;
      color: #4a5568;
    }
    
    .balance-card .amount {
      font-weight: 600;
    }
    
    .balance-card .ingreso {
      color: var(--success-color);
    }
    
    .balance-card .egreso {
      color: var(--danger-color);
    }
    
    .summary-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
    }
    
    .summary-card h3 {
      font-size: 1.3rem;
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
    }
    
    .summary-item {
      padding: 15px;
      border-radius: 8px;
      background: #f8fafc;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    
    .summary-item .label {
      font-size: 1rem;
      color: #4a5568;
      margin-bottom: 8px;
    }
    
    .summary-item .value {
      font-size: 1.8rem;
      font-weight: 700;
    }
    
    .summary-item.ingresos .value {
      color: var(--success-color);
    }
    
    .summary-item.egresos .value {
      color: var(--danger-color);
    }
    
    .summary-item.saldo .value {
      color: var(--primary-color);
    }
    
    /* Estilos para la vista de Conciliación */
    .conciliacion-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .conciliacion-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      transition: transform 0.3s ease;
    }
    
    .conciliacion-card:hover {
      transform: translateY(-5px);
    }
    
    .conciliacion-card h3 {
      font-size: 1.3rem;
      color: var(--primary-color);
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 2px solid #e2e8f0;
    }
    
    .conciliacion-status {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-top: 20px;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .status-bar {
      flex-grow: 1;
      height: 10px;
      background: #e2e8f0;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .status-fill {
      height: 100%;
      background: var(--success-color);
    }
    
    .status-fill.pending {
      background: var(--warning-color);
    }
    
    /* Dashboard */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 25px;
      margin-bottom: 30px;
    }
    
    .chart-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      height: 400px;
      display: flex;
      flex-direction: column;
    }
    
    .chart-card h3 {
      font-size: 1.3rem;
      color: var(--primary-color);
      margin-bottom: 20px;
    }
    
    .chart-card canvas {
      flex-grow: 1;
      width: 100% !important;
      height: 300px !important;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .btn-wrapper {
        max-width: 100%;
      }
      
      .saldo-grid {
        grid-template-columns: 1fr;
      }
      
      .totals-container {
        grid-template-columns: 1fr;
      }
      
      .table-header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .filters {
        width: 100%;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .action-button {
        width: 100%;
        justify-content: center;
      }
      
      .conciliacion-grid {
        grid-template-columns: 1fr;
      }
      
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }
    
    /* Nuevos estilos para el informe por rubro */
    .rubro-container {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 30px;
    }
    
    .rubro-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }
    
    .rubro-title {
      font-size: 1.4rem;
      color: var(--primary-color);
      font-weight: 600;
    }
    
    .rubro-bar {
      height: 10px;
      background: #e2e8f0;
      border-radius: 5px;
      margin-bottom: 15px;
      overflow: hidden;
    }
    
    .rubro-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success-color), var(--primary-color));
    }
    
    .rubro-info {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    
    .rubro-label {
      font-weight: 500;
    }
    
    .rubro-value {
      font-weight: 600;
    }
    
    /* Nuevos estilos para secciones agregadas */
    .form-section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
      margin-bottom: 25px;
    }
    
    .form-section h3 {
      color: var(--primary-color);
      font-size: 1.3rem;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }
    
    .form-group {
      margin-bottom: 15px;
    }
    
    .form-section .submit-btn {
      padding: 12px 25px;
      font-size: 16px;
      margin-top: 10px;
    }
    
    .form-section label {
      font-size: 0.9rem;
    }
    /* Animación 1: Flotación suave */
    .float-animation .features-item:hover {
      transform: translateY(-10px);
      box-shadow: 0 15px 30px rgba(231, 76, 60, 0.2);
    }
    /* Efecto al hacer hover */
    .icon-box:hover::after {
      background: linear-gradient(to right,
          rgba(255, 255, 255, 0) 0%,
          rgba(255, 255, 255, 0.7) 50%,
          rgba(255, 255, 255, 0) 100%);
      animation-duration: 1s;
    }


    /* ESTILOS PREVIOS (conservados) */
    :root {
        --primary-color: #2c5282;
        --secondary-color: #4CAF50;
        --danger-color: #e53e3e;
        --success-color: #48bb78;
        --warning-color: #dd6b20;
        --purple-color: #805ad5;
        --orange-color: #dd6b20;
        --light-bg: #f8f9fa;
    }

    /* ... (los estilos previos se mantienen intactos) ... */

    /* Nuevos estilos para pestañas */
    .tabs {
        display: flex;
        margin-bottom: 20px;
        border-bottom: 2px solid #e2e8f0;
    }
    
    .tab-button {
        padding: 12px 20px;
        background: #edeef6;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-weight: 600;
        color: #4a5568;
        transition: all 0.3s ease;
        margin-right: 5px;
        border-radius: 6px 6px 0 0;
    }
    
    .tab-button.active {
        border-bottom-color: var(--primary-color);
        background: #edeef6;
        color: var(--primary-color);
    }
    
    .tab-button:hover:not(.active) {
        background: #ffffff;
    }
    
    .tab-content {
        display: none;
        padding: 15px;
        background: white;
        border-radius: 0 0 8px 8px;
    }
    
    .tab-content.active {
        display: block;
    }
    
    .sub-tabs {
        display: flex;
        margin-bottom: 15px;
    }
    
    .sub-tab-button {
        padding: 10px 15px;
        background: #f8fafc;
        border: none;
        cursor: pointer;
        font-weight: 500;
        color: #4a5568;
        transition: all 0.3s ease;
        margin-right: 5px;
        border-radius: 4px;
    }
    
    .sub-tab-button.active {
        background: var(--primary-color);
        color: white;
    }
    
    .sub-tab-button:hover:not(.active) {
        background: #edf2f7;
    }
    
    .sub-tab-content {
        display: none;
    }
    
    .sub-tab-content.active {
        display: block;
    }
    
    /* Estilos para nueva vista de giros y depósitos */
    .giros-depositos-section {
        display: none;
    }
    
    .form-section {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
        margin-bottom: 25px;
    }
    
    .form-section h3 {
        color: var(--primary-color);
        font-size: 1.3rem;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #e2e8f0;
    }
    
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .form-group {
        margin-bottom: 15px;
    }
    
    .form-section .submit-btn {
        padding: 12px 25px;
        font-size: 16px;
        margin-top: 10px;
    }
    
    .form-section label {
        font-size: 0.9rem;
    }
    /* Nuevo estilo para notificaciones */
    .notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 3000 !important;
      padding: 15px 25px;
      background-color: var(--success-color);
      color: white;
      border-radius: 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      /* z-index: 1000; */
      display: none;
      animation: fadeInOut 3s ease;
    }
    
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-20px); }
      10% { opacity: 1; transform: translateY(0); }
      90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-20px); }
    }
    
    /* Nuevos estilos para el botón de editar */
    .edit-btn {
      background: linear-gradient(120deg, #0c94c9, #0a7ea8);
      color: white;
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .edit-btn:hover {
      background: linear-gradient(120deg, #0a7ea8, #096b8d);
    }
    
    /* Estilos para el comprobante PDF */
    .comprobante-container {
      background: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      max-width: 600px;
      margin: 0 auto;
      font-family: 'Poppins', sans-serif;
    }
    
    .comprobante-header {
      text-align: center;
      margin-bottom: 20px;
      border-bottom: 2px solid #2c5282;
      padding-bottom: 15px;
    }
    
    .comprobante-title {
      color: #2c5282;
      font-size: 1.8rem;
      margin-bottom: 5px;
    }
    
    .comprobante-subtitle {
      color: #4a5568;
      font-size: 1.2rem;
    }
    
    .comprobante-body {
      margin: 25px 0;
    }
    
    .comprobante-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #eee;
    }
    
    .comprobante-label {
      font-weight: 600;
      color: #2d3748;
    }
    
    .comprobante-value {
      color: #4a5568;
    }
    
    .comprobante-total {
      font-weight: 700;
      font-size: 1.2rem;
      color: #2c5282;
    }
    
    .comprobante-footer {
      text-align: center;
      margin-top: 30px;
      color: #718096;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
<div id="notification" class="notification"></div>
  
  <div class="container">
    <!-- Vista de Registro de Ingresos/Egresos -->
    <div id="registroSection" class="registro-section">
      <div class="card">
        <div class="card-header">
          <div>Sistema de Gestión Financiera</div>
        </div>
        <div class="card-body">
          <h1>Registro de Ingresos y Egresos</h1>

          <div class="btn-wrapper">
            <button id="ingresosBtn">
              <i class="bi bi-cash-coin"></i>Registro de Ingresos
            </button>
            <button id="egresosBtn">
              <i class="bi bi-credit-card"></i>Registro de Egresos
            </button>
            <button id="giroDepositosBtn">
              <i class="bi bi-arrow-left-right"></i>Giros y Depósitos
            </button>
            <button id="libroCajaBtn">
              <i class="bi bi-journal-bookmark"></i>Libro de Caja Tabular
            </button>
            <button id="balanceBtn">
              <i class="bi bi-bar-chart"></i>Balance
            </button>
            <button id="conciliacionBtn">
              <i class="bi bi-bank"></i>Conciliación Bancaria
            </button>
            <button id="informeRubroBtn">
              <i class="bi bi-pie-chart"></i>Informe por Rubro
            </button>
            <button id="movimientosBtn">
              <i class="bi bi-list-check"></i>Movimientos
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal de Ingresos MODIFICADO con pestañas -->
    <div id="ingresosModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="bi bi-cash-coin"></i> Registro de Ingresos</h2>
          <button class="modal-close" id="closeIngresosModal">Cerrar</button>
        </div>
        
        <form id="ingresosForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
            <!-- Columna 1 -->
            <div>
              <label for="fecha-ingresos">Fecha</label>
              <input type="date" id="fecha-ingresos" name="fecha" required style="width: 100%;">
              
              <label for="nro-dcto-ingresos">N° Comprobante</label>
              <input type="text" id="nro-dcto-ingresos" name="nro_dcto" placeholder="Ingrese número de comprobante" required style="width: 100%;">
              
              <label for="categoria-ingresos">Categoría de Ingreso</label>
              <select id="categoria-ingresos" name="categoria" required style="width: 100%;">
                <option value="">-- Selecciona una categoría --</option>
                <option value="venta_agua">Venta de Agua (Total Consumo)</option>
                <option value="cuotas_incorporacion">Cuotas de Incorporación</option>
                <option value="venta_medidores">Venta de Medidores (Otros Ingresos)</option>
                <option value="trabajos_domicilio">Trabajos en Domicilio (Otros Ingresos)</option>
                <option value="subsidios">Subsidios (Otros Ingresos)</option>
                <option value="otros_aportes">Otros Aportes (Otros Ingresos)</option>
                <option value="multas_inasistencia">Multas Inasistencia (Otros Ingresos)</option>
                <option value="otras_multas">Otras Multas (Otros Ingresos)</option>
              </select>
              
              <label for="cuenta-destino">Cuenta Destino</label>
              <select id="cuenta-destino" name="cuenta_destino" required style="width: 100%;">
                <option value="">-- Selecciona una cuenta --</option>
                <option value="caja_general">Caja General</option>
                <option value="cuenta_corriente_1">Cuenta Corriente 1</option>
                <option value="cuenta_corriente_2">Cuenta Corriente 2</option>
              </select>
            </div>
            
            <!-- Columna 2 -->
            <div>
              <label for="descripcion-ingresos">Descripción</label>
              <textarea id="descripcion-ingresos" name="descripcion" required
                            style="width: 100%; padding: 14px; min-height: 100px; border: 1px solid #ddd; border-radius: 8px; resize: vertical;"></textarea>
              
              <label for="monto-ingresos">Monto</label>
              <input type="number" id="monto-ingresos" name="monto" step="0.01" required class="monto-input" style="width: 100%;">
            </div>
          </div>
          
          <div style="grid-column: span 2; margin-top: 20px; display: flex; gap: 15px;">
            <button type="submit" class="submit-btn" style="flex: 1;">
              <i class="bi bi-save"></i> Registrar Ingreso
            </button>
            <button id="imprimirComprobanteBtn" class="submit-btn" style="flex: 1; background: linear-gradient(120deg, #0c94c9, #0a7ea8);">
              <i class="bi bi-printer"></i> Imprimir Comprobante
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal de Egresos -->
<div id="egresosModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2><i class="bi bi-credit-card"></i> Registro de Egresos</h2>
      <button class="modal-close" id="closeEgresosModal">Cerrar</button>
    </div>
    <form id="egresosForm">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
        <!-- Columna 1 -->
        <div>
          <label for="fecha-egresos">Fecha</label>
          <input type="date" id="fecha-egresos" name="fecha" required style="width: 100%;">
          
          <label for="nro-dcto-egresos">N° Boleta/Factura</label>
          <input type="text" id="nro-dcto-egresos" name="nro_dcto" placeholder="Ingrese número de comprobante" required style="width: 100%;">
          
          <label for="categoria-egresos">Categoría de Egreso</label>
          <select id="categoria-egresos" name="categoria" required style="width: 100%;">
            <option value="">-- Selecciona una categoría --</option>
            <option value="energia_electrica">ENERGÍA ELECTRICA</option>
            <option value="sueldos">SUELDOS/LEYES SOCIALES</option>
            <option value="otras_cuentas">Otras Ctas. (Agua, Int. Cel.)</option>
            <option value="mantencion">Mantención y reparaciones Instalaciones</option>
            <option value="insumos_oficina">Insumos y Materiales (Oficina)</option>
            <option value="materiales_red">Materiales e Insumos (Red)</option>
            <option value="viaticos">Viáticos / Seguros / Movilización</option>
            <option value="trabajos_domicilio">Gastos por Trabajos en domicilio</option>
            <option value="mejoramiento">Mejoramiento / Inversiones</option>
          </select>
          
          <label for="cuenta-origen">Cuenta Origen</label>
          <select id="cuenta-origen" name="cuenta_origen" required style="width: 100%;">
            <option value="">-- Selecciona una cuenta --</option>
            <option value="caja_general">Caja General</option>
            <option value="cuenta_corriente_1">Cuenta Corriente 1</option>
            <option value="cuenta_corriente_2">Cuenta Corriente 2</option>
          </select>
        </div>
        
        <!-- Columna 2 -->
        <div>
          <label for="proveedor">Razón Social Proveedor</label>
          <input type="text" id="razon_social" name="razon_social" placeholder="Razón Social" required style="width: 100%;">
          
          <label for="domicilio">R.U.T.</label>
          <input type="text" id="rut" name="rut_proveedor" placeholder="RUT del Proveedor" style="width: 100%;">
          
          <label for="descripcion-egresos">Descripción</label>
            <textarea id="descripcion-egresos" name="descripcion" required
                      style="width: 100%; padding: 14px; min-height: 100px; border: 1px solid #ddd; border-radius: 8px; resize: vertical;"></textarea>
          
          
          <label for="monto-egresos">Monto</label>
          <input type="number" id="monto-egresos" name="monto" step="0.01" required class="monto-input" style="width: 100%;">
        </div>
      </div>
      
      <div style="grid-column: span 2; margin-top: 20px; display: flex; gap: 15px;">
        <button type="submit" class="submit-btn" style="flex: 1;">
          <i class="bi bi-save"></i> Registrar Egreso
        </button>
        <button id="imprimirComprobanteEgresoBtn" class="submit-btn" style="flex: 1; background: linear-gradient(120deg, #0c94c9, #0a7ea8);">
          <i class="bi bi-printer"></i> Imprimir Comprobante
        </button>
      </div>
    </form>
  </div>
</div>

    <!-- Nueva Vista: Giros y Depósitos -->
<div id="girosDepositosSection" class="giros-depositos-section">
  <div class="section-header" style="display: flex; align-items: center; justify-content: space-between;">
    <div>
      <h1 style="margin: 0;">Giros y Depósitos</h1>
      <p style="margin: 0;">Movimientos entre cuentas</p>
    </div>
    <button id="volverGirosDepositosBtn" class="action-button volver" style="margin-left: 20px;">
      <i class="bi bi-arrow-left"></i> Volver al Registro
    </button>
  </div>
  
  <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-top: 20px;">
    <!-- Sección Giros -->
    <div class="form-section" style="border-right: 1px solid #eee; padding-right: 20px;">
      <h3><i class="bi bi-send"></i> GIROS (Desde Cta. Cte./ Cta. Ahorro -> Caja General)</h3>
      <form id="girosForm">
        <!-- AJUSTA EL GAP VERTICAL AQUÍ (primer valor = vertical, segundo = horizontal) -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 0px 0px;">
          <div class="form-group">
            <label for="fecha-giro">Fecha</label>
            <input type="date" id="fecha-giro" name="fecha" required style="width: 100%;">
          </div>
          <div class="form-group">
            <label for="monto-giro">Monto</label>
            <input type="number" id="monto-giro" name="monto" step="0.01" required style="width: 100%;">
          </div>
          <div class="form-group">
            <label for="cuenta-giro">Cuenta Origen</label>
            <select id="cuenta-giro" name="cuenta" required style="width: 100%;">
              <option value="cuenta_corriente_1">Cuenta Corriente 1</option>
              <option value="cuenta_corriente_2">Cuenta Corriente 2</option>
            </select>
          </div>
          <div class="form-group">
            <label for="detalle-giro">Detalle</label>
            <input type="text" id="detalle-giro" name="detalle" placeholder="Detalle del giro" required style="width: 100%;">
          </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
          <button type="submit" class="submit-btn">
            <i class="bi bi-save"></i> Registrar Giro
          </button>
        </div>
      </form>
    </div>
    
    <!-- Sección Depósitos -->
    <div class="form-section">
      <h3><i class="bi bi-bank"></i> DEPÓSITOS (Desde Caja General -> Cta. Cte./ Cta. Ahorro)</h3>
      <form id="depositosForm">
        <!-- AJUSTA EL GAP VERTICAL AQUÍ (mismo valor que en Giros para consistencia) -->
        <div style="display: grid; grid-template-columns: 1fr; gap: 0px px;">
          <div class="form-group">
            <label for="fecha-deposito">Fecha</label>
            <input type="date" id="fecha-deposito" name="fecha" required style="width: 100%;">
          </div>
          <div class="form-group">
            <label for="monto-deposito">Monto</label>
            <input type="number" id="monto-deposito" name="monto" step="0.01" required style="width: 100%;">
          </div>
          <div class="form-group">
            <label for="cuenta-deposito">Cuenta Destino</label>
            <select id="cuenta-deposito" name="cuenta" required style="width: 100%;">
              <option value="cuenta_corriente_1">Cuenta Corriente 1</option>
              <option value="cuenta_corriente_2">Cuenta Corriente 2</option>
            </select>
          </div>
          <div class="form-group">
            <label for="detalle-deposito">Detalle</label>
            <input type="text" id="detalle-deposito" name="detalle" placeholder="Detalle del depósito" required style="width: 100%;">
          </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center;">
          <button type="submit" class="submit-btn">
            <i class="bi bi-save"></i> Registrar Depósito
          </button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Botón Volver movido al header -->
</div>

    <!-- Vista de Libro de Caja Tabular -->
    <div id="libroCajaSection" class="libro-caja-section">
      <div class="section-header" style="display: flex; align-items: center; justify-content: space-between;">
        <div>
          <h1 style="margin: 0;">Libro de Caja Tabular</h1>
          <p style="margin: 0;">Registro diario de todos los movimientos financieros</p>
        </div>
        <button id="volverBtn" class="action-button volver" style="margin-left: 20px;">
          <i class="bi bi-arrow-left"></i> Volver al Registro
        </button>
      </div>
      
      <div class="saldo-section">
        <div class="saldo-grid">
          <div class="saldo-item">
            <label>Saldo Caja General</label>
            <input id="saldoCajaGeneral" type="text" value="$0" readonly>
          </div>
          <div class="saldo-item">
            <label>Saldo Cuenta Corriente 1</label>
            <input id="saldoCuentaCorriente1" type="text" value="$0" readonly>
          </div>
          <div class="saldo-item">
            <label>Saldo Cuenta Corriente 2</label>
            <input id="saldoCuentaCorriente2" type="text" value="$0" readonly>
          </div>
          <div class="saldo-item">
            <label>Saldo Total</label>
            <input id="saldoTotal" type="text" class="bg-gray-100" readonly>
          </div>
        </div>
      </div>
       
      <div class="totals-container">
        <div class="total-card ingresos">
          <h3>Total Ingresos</h3>
          <div class="value" id="totalIngresos">$0</div>
        </div>
        <div class="total-card egresos">
          <h3>Total Egresos</h3>
          <div class="value" id="totalEgresos">$0</div>
        </div>
        <div class="total-card saldo">
          <h3>Saldo Final</h3>
          <div class="value" id="saldoFinal">$0</div>
        </div>
      </div>
      
      <div class="table-container">
        <div class="table-header">
          <h2>Movimientos Financieros</h2>
          <div class="filters">
            <div class="filter-group">
              <label>Desde</label>
              <input id="fechaDesde" type="date">
            </div>
            <div class="filter-group">
              <label>Hasta</label>
              <input id="fechaHasta" type="date">
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button onclick="filtrarPorFechas()" class="action-button" style="padding: 10px 15px;">
                <i class="bi bi-funnel"></i> Filtrar
              </button>
            </div>
          </div>
        </div>
        
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th colspan="7" class="ingresos-header">Entradas Ingresos</th>
                <th colspan="9" class="egresos-header">Salidas Egresos</th>
              </tr>
              <tr>
    <th>Acciones</th>
                <th>Fecha</th>
                <th>Descripción</th>
                <th>Total Consumo</th>
                <th>Cuotas Incorporación</th>
                <th>Otros Ingresos</th>
                <th>Giros</th>
                <th>TOTAL INGRESOS</th>
                <th>ENERGÍA ELÉCTRICA</th>
                <th>SUELDOS/LEYES SOCIALES</th>
                <th>OTROS GASTOS DE OPERACIÓN</th>
                <th>GASTOS MANTENCION</th>
                <th>GASTOS ADMINISTRACION</th>
                <th>GASTOS MEJORAMIENTO</th>
                <th>OTROS EGRESOS</th>
                <th>DEPÓSITOS</th>
                <th>TOTAL EGRESOS</th>
              </tr>
            </thead>
            <tbody id="tablaMovimientos">
              <!-- Los movimientos se generarán dinámicamente aquí -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Botón Volver movido al header -->
    </div>

    <!-- Vista de Balance -->
    <div id="balanceSection" class="balance-section">
      <div class="section-header" style="display: flex; align-items: center; justify-content: space-between;">
        <div>
          <h1 style="margin: 0;">Balance Financiero</h1>
          <p style="margin: 0;">Resumen gráfico y analítico de la situación financiera</p>
        </div>
        <button id="volverBalanceBtn" class="action-button volver" style="margin-left: 20px;">
          <i class="bi bi-arrow-left"></i> Volver al Registro
        </button>
      </div>
      
      <div class="summary-card">
        <div class="summary-grid">
          <div class="summary-item ingresos">
            <div class="label">Total Ingresos</div>
            <div class="value" id="balanceTotalIngresos">$0</div>
          </div>
          <div class="summary-item egresos">
            <div class="label">Total Egresos</div>
            <div class="value" id="balanceTotalEgresos">$0</div>
          </div>
          <div class="summary-item saldo">
            <div class="label">Saldo Final</div>
            <div class="value" id="balanceSaldoFinal">$0</div>
          </div>
        </div>
      </div>
      
      <div class="dashboard-grid">
        <div class="chart-card">
          <h3>Distribución de Ingresos</h3>
          <canvas id="ingresosChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Distribución de Egresos</h3>
          <canvas id="egresosChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Flujo Mensual</h3>
          <canvas id="flujoChart"></canvas>
        </div>
        <div class="chart-card">
          <h3>Conciliación Bancaria</h3>
          <canvas id="conciliacionChart"></canvas>
        </div>
      </div>
      
      <div class="balance-grid">
        <div class="balance-card">
          <h3><i class="bi bi-arrow-up-circle"></i> Ingresos por Categoría</h3>
          <ul id="balanceIngresos">
            <!-- Los ingresos por categoría se generarán aquí -->
          </ul>
        </div>
        
        <div class="balance-card">
          <h3><i class="bi bi-arrow-down-circle"></i> Egresos por Categoría</h3>
          <ul id="balanceEgresos">
            <!-- Los egresos por categoría se generarán aquí -->
          </ul>
        </div>
        
        <div class="balance-card">
          <h3><i class="bi bi-clock-history"></i> Últimos Movimientos</h3>
          <ul id="balanceMovimientos">
            <!-- Los últimos movimientos se generarán aquí -->
          </ul>
        </div>
        
        <div class="balance-card">
          <h3><i class="bi bi-graph-up"></i> Análisis Financiero</h3>
          <div style="padding: 15px;">
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>Flujo de efectivo:</span>
                <span id="flujoEfectivo" style="font-weight: 600;">$0</span>
              </div>
              <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                <div id="flujoBar" style="height: 100%; width: 50%; background: var(--success-color);"></div>
              </div>
            </div>
            
            <div style="margin-bottom: 20px;">
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>Proporción ingresos/egresos:</span>
                <span id="proporcionIngEgr" style="font-weight: 600;">1:1</span>
              </div>
              <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                <div id="proporcionBar" style="height: 100%; width: 50%; background: var(--primary-color);"></div>
              </div>
            </div>
            
            <div>
              <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <span>Porcentaje de ahorro:</span>
                <span id="porcentajeAhorro" style="font-weight: 600;">0%</span>
              </div>
              <div style="height: 8px; background: #e2e8f0; border-radius: 4px; overflow: hidden;">
                <div id="ahorroBar" style="height: 100%; width: 0%; background: var(--secondary-color);"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Botón Volver movido al header -->
    </div>

    <!-- Vista de Conciliación Bancaria -->
    <div id="conciliacionSection" class="conciliacion-section">
      <div class="section-header" style="display: flex; align-items: center; justify-content: space-between;">
        <div>
          <h1 style="margin: 0;">Conciliación Bancaria</h1>
          <p style="margin: 0;">Comparación de movimientos registrados con extractos bancarios</p>
        </div>
        <button id="volverConciliacionBtn" class="action-button volver" style="margin-left: 20px;">
          <i class="bi bi-arrow-left"></i> Volver al Registro
        </button>
      </div>
      
      <div class="conciliacion-grid">
        <div class="conciliacion-card">
          <h3><i class="bi bi-journal-check"></i> Movimientos Registrados</h3>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>N° Comp.</th>
                  <th>Descripción</th>
                  <th>Cuenta</th>
                  <th>Monto</th>
                  <th>Conciliado</th>
                </tr>
              </thead>
              <tbody id="tablaConciliacion">
                <!-- Movimientos para conciliación -->
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="conciliacion-card">
          <h3><i class="bi bi-bank"></i> Extracto Bancario</h3>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Fecha</th>
                  <th>Descripción</th>
                  <th>Monto</th>
                  <th>Conciliado</th>
                </tr>
              </thead>
              <tbody id="tablaExtracto">
                <!-- Extracto bancario -->
              </tbody>
            </table>
          </div>
          
          <div class="conciliacion-card">
            <h3><i class="bi bi-check-circle"></i> Estado de Conciliación</h3>
            <div class="conciliacion-status">
              <div class="status-item">
                <span>Conciliados</span>
                <div class="status-bar">
                  <div class="status-fill" style="width: 75%"></div>
                </div>
                <span>75%</span>
              </div>
              <div class="status-item">
                <span>Pendientes</span>
                <div class="status-bar">
                  <div class="status-fill pending" style="width: 25%"></div>
                </div>
                <span>25%</span>
              </div>
            </div>
          </div>
          
          <div class="button-group" style="margin-top: 20px;">
            <button onclick="cargarExtracto()" class="action-button">
              <i class="bi bi-upload"></i> Cargar Extracto
            </button>
            <button onclick="conciliar()" class="action-button">
              <i class="bi bi-check-circle"></i> Conciliar
            </button>
          </div>
        </div>
      </div>
      
      <div class="button-group">
        <!-- Botón Volver movido al header -->
      </div>
    </div>

    <!-- Vista de Informe por Rubro -->
    <div id="informeRubroSection" class="balance-section">
      <div class="section-header" style="display: flex; align-items: center; justify-content: space-between;">
        <div>
          <h1 style="margin: 0;">Informe por Rubro</h1>
          <p style="margin: 0;">Comparación de ingresos y egresos por categorías</p>
        </div>
        <button id="volverInformeRubroBtn" class="action-button volver" style="margin-left: 20px;">
          <i class="bi bi-arrow-left"></i> Volver al Registro
        </button>
      </div>
      
      <div class="rubro-container">
        <div class="rubro-header">
          <div class="rubro-title">Operaciones vs. Administración</div>
          <div class="rubro-value">$0 / $0</div>
        </div>
        <div class="rubro-bar">
          <div class="rubro-bar-fill" style="width: 50%;"></div>
        </div>
        <div class="rubro-info">
          <div class="rubro-label">Gastos Operativos:</div>
          <div class="rubro-value" id="gastoOperativo">$0</div>
        </div>
        <div class="rubro-info">
          <div class="rubro-label">Gastos Administrativos:</div>
          <div class="rubro-value" id="gastoAdministrativo">$0</div>
        </div>
      </div>
      
      <div class="rubro-container">
        <div class="rubro-header">
          <div class="rubro-title">Mantención vs. Multas</div>
          <div class="rubro-value">$0 / $0</div>
        </div>
        <div class="rubro-bar">
          <div class="rubro-bar-fill" style="width: 50%;"></div>
        </div>
        <div class="rubro-info">
          <div class="rubro-label">Gasto en Mantención:</div>
          <div class="rubro-value" id="gastoMantencion">$0</div>
        </div>
        <div class="rubro-info">
          <div class="rubro-label">Recaudado por Multas:</div>
          <div class="rubro-value" id="recaudoMultas">$0</div>
        </div>
      </div>
      
      <!-- Botón corregido: ahora dentro del button-group -->
      <div class="button-group">
        <button onclick="exportarPDF('informeRubro')" class="action-button pdf">
          <i class="bi bi-file-earmark-pdf"></i> Exportar Informe
        </button>
      </div>
    </div>

    <!-- Nueva Vista: Movimientos -->
    <div id="movimientosSection" class="movimientos-section">
      <div class="section-header" style="display: flex; align-items: center; justify-content: space-between;">
        <div>
          <h1 style="margin: 0;">Registro de Movimientos</h1>
          <p style="margin: 0;">Historial completo de todos los movimientos financieros</p>
        </div>
        <div style="display: flex; flex-direction: column; align-items: flex-end;">
          <button id="volverMovimientosBtn" class="action-button volver" style="margin-left: 20px;">
            <i class="bi bi-arrow-left"></i> Volver al Registro
          </button>
          <button onclick="exportarExcel()" class="action-button excel" style="margin-top: 8px;">
            <i class="bi bi-file-earmark-excel"></i> Exportar a Excel
          </button>
        </div>
      </div>
      
      <div class="table-container">
        <div class="table-header">
          <h2>Movimientos Financieros</h2>
          <div class="filters">
            <div class="filter-group">
              <label>Tipo</label>
              <select id="filtroTipo">
                <option value="">Todos</option>
                <option value="ingreso">Ingreso</option>
                <option value="egreso">Egreso</option>
                <option value="transferencia">Transferencia</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Categoría</label>
              <select id="filtroCategoria">
                <option value="">Todas</option>
                <!-- Se llenará dinámicamente -->
              </select>
            </div>
            <div class="filter-group">
              <label>Cuenta</label>
              <select id="filtroCuenta">
                <option value="">Todas</option>
                <option value="caja_general">Caja General</option>
                <option value="cuenta_corriente_1">Cuenta Corriente 1</option>
                <option value="cuenta_corriente_2">Cuenta Corriente 2</option>
              </select>
            </div>
            <div class="filter-group">
              <label>Desde</label>
              <input id="filtroFechaDesde" type="date">
            </div>
            <div class="filter-group">
              <label>Hasta</label>
              <input id="filtroFechaHasta" type="date">
            </div>
            <div class="filter-group">
              <label>&nbsp;</label>
              <button onclick="filtrarMovimientos()" class="action-button" style="padding: 10px 15px;">
                <i class="bi bi-funnel"></i> Filtrar
              </button>
            </div>
          </div>
        </div>
        
        <div style="overflow-x: auto;">
          <table>
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Categoría</th>
                <th>Descripción</th>
                <th>Cuenta</th>
                <th>Monto</th>
                <th>N° Comprobante</th>
                <th>Proveedor</th>
                <th>RUT Proveedor</th>
              </tr>
            </thead>
            <tbody id="tablaTodosMovimientos">
              <!-- Todos los movimientos se generarán aquí -->
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Botón Exportar a Excel movido debajo de Volver al Registro -->
    </div>
  </div>
  
  <!-- Contenedor oculto para generar el PDF del comprobante -->
  <div id="comprobantePDF" style="display: none;"></div>

 <script>
  // Variables globales
  let movimientos = JSON.parse(localStorage.getItem('movimientos')) || [];
  let saldosCuentas = {
    caja_general: parseFloat(localStorage.getItem('saldoCajaGeneral')) || 0,
    cuenta_corriente_1: parseFloat(localStorage.getItem('saldoCuentaCorriente1')) || 0,
    cuenta_corriente_2: parseFloat(localStorage.getItem('saldoCuentaCorriente2')) || 0
  };
  let comprobanteCounter = parseInt(localStorage.getItem('comprobanteCounter')) || 1;
  let chartIngresos, chartEgresos, chartFlujo, chartConciliacion;
  let movimientoEditando = null;

  // Mapeo de categorías
  const categoriasIngresos = {
    venta_agua: "Venta de Agua (Total Consumo)",
    cuotas_incorporacion: "Cuotas de Incorporación",
    venta_medidores: "Venta de Medidores",
    trabajos_domicilio: "Trabajos en Domicilio",
    subsidios: "Subsidios",
    otros_aportes: "Otros Aportes",
    multas_inasistencia: "Multas Inasistencia",
    otras_multas: "Otras Multas"
  };

  const categoriasEgresos = {
    energia_electrica: "ENERGÍA ELECTRICA",
    sueldos: "SUELDOS/LEYES SOCIALES",
    otras_cuentas: "Otras Ctas. (Agua, Int. Cel.)",
    mantencion: "Mantención y reparaciones Instalaciones",
    insumos_oficina: "Insumos y Materiales (Oficina)",
    materiales_red: "Materiales e Insumos (Red)",
    viaticos: "Viáticos / Seguros / Movilización",
    trabajos_domicilio: "Gastos por Trabajos en domicilio",
    mejoramiento: "Mejoramiento / Inversiones"
  };

  // Mapeo de categorías de egresos a grupos para el libro de caja
  const gruposEgresos = {
    energia_electrica: "ENERGÍA ELÉCTRICA",
    sueldos: "SUELDOS/LEYES SOCIALES",
    otras_cuentas: "OTROS GASTOS DE OPERACIÓN",
    mantencion: "GASTOS MANTENCION",
    trabajos_domicilio: "GASTOS MANTENCION",
    insumos_oficina: "GASTOS ADMINISTRACION",
    materiales_red: "GASTOS MEJORAMIENTO",
    mejoramiento: "GASTOS MEJORAMIENTO",
    viaticos: "OTROS EGRESOS"
  };

  // Mapeo de cuentas
  const cuentas = {
    caja_general: "Caja General",
    cuenta_corriente_1: "Cuenta Corriente 1",
    cuenta_corriente_2: "Cuenta Corriente 2"
  };

  // Función para formatear valores monetarios
  function formatearMoneda(valor) {
    return new Intl.NumberFormat('es-CL', {
      style: 'currency',
      currency: 'CLP'
    }).format(valor);
  }

  // Función para actualizar los saldos de las cuentas
  function actualizarSaldosCuentas() {
    document.getElementById('saldoCajaGeneral').value = formatearMoneda(saldosCuentas.caja_general);
    document.getElementById('saldoCuentaCorriente1').value = formatearMoneda(saldosCuentas.cuenta_corriente_1);
    document.getElementById('saldoCuentaCorriente2').value = formatearMoneda(saldosCuentas.cuenta_corriente_2);
    
    const saldoTotal = saldosCuentas.caja_general + saldosCuentas.cuenta_corriente_1 + saldosCuentas.cuenta_corriente_2;
    document.getElementById('saldoTotal').value = formatearMoneda(saldoTotal);
    
    localStorage.setItem('saldoCajaGeneral', saldosCuentas.caja_general);
    localStorage.setItem('saldoCuentaCorriente1', saldosCuentas.cuenta_corriente_1);
    localStorage.setItem('saldoCuentaCorriente2', saldosCuentas.cuenta_corriente_2);
  }

  // Función para actualizar los totales
  function actualizarTotales() {
    const totalIngresos = movimientos
      .filter(m => m.tipo === 'ingreso')
      .reduce((total, m) => total + m.monto, 0);
    
    const totalEgresos = movimientos
      .filter(m => m.tipo === 'egreso')
      .reduce((total, m) => total + m.monto, 0);
    
    const saldoFinal = totalIngresos - totalEgresos;
    
    document.getElementById('totalIngresos').textContent = formatearMoneda(totalIngresos);
    document.getElementById('totalEgresos').textContent = formatearMoneda(totalEgresos);
    document.getElementById('saldoFinal').textContent = formatearMoneda(saldoFinal);
    
    document.getElementById('balanceTotalIngresos').textContent = formatearMoneda(totalIngresos);
    document.getElementById('balanceTotalEgresos').textContent = formatearMoneda(totalEgresos);
    document.getElementById('balanceSaldoFinal').textContent = formatearMoneda(saldoFinal);
    
    actualizarInformeRubro();
  }

  // Función para actualizar la tabla de movimientos
  function actualizarTabla() {
    const tabla = document.getElementById('tablaMovimientos');
    tabla.innerHTML = '';
    
    if (movimientos.length === 0) {
      const fila = document.createElement('tr');
      fila.innerHTML = `<td colspan="17" style="text-align: center; padding: 20px;">No hay movimientos registrados</td>`;
      tabla.appendChild(fila);
      return;
    }

    movimientos.forEach(mov => {
      const fila = document.createElement('tr');
      const botonEditar = `
        <button class="edit-btn" onclick="editarMovimiento('${mov.id}')">
          <i class="bi bi-pencil"></i> Editar
        </button>
      `;

      if (mov.tipo === 'ingreso') {
        let totalConsumo = mov.categoria === 'venta_agua' ? mov.monto : 0;
        let cuotasIncorporacion = mov.categoria === 'cuotas_incorporacion' ? mov.monto : 0;
        let otrosIngresos = ['venta_medidores', 'trabajos_domicilio', 'subsidios', 'otros_aportes', 'multas_inasistencia', 'otras_multas'].includes(mov.categoria) ? mov.monto : 0;
        let giros = mov.categoria === 'giro' ? mov.monto : 0;
        
        fila.innerHTML = `
          <td>${botonEditar}</td>
          <td>${mov.fecha}</td>
          <td>${mov.descripcion}</td>
          <td class="ingreso-cell">${formatearMoneda(totalConsumo)}</td>
          <td class="ingreso-cell">${formatearMoneda(cuotasIncorporacion)}</td>
          <td class="ingreso-cell">${formatearMoneda(otrosIngresos)}</td>
          <td class="ingreso-cell">${formatearMoneda(giros)}</td>
          <td class="ingreso-cell">${formatearMoneda(mov.monto)}</td>
          <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
          <td></td>
        `;
      } else if (mov.tipo === 'egreso') {
        let energiaElectrica = mov.categoria === 'energia_electrica' ? mov.monto : 0;
        let sueldos = mov.categoria === 'sueldos' ? mov.monto : 0;
        let otrosGastosOperacion = mov.categoria === 'otras_cuentas' ? mov.monto : 0;
        let gastosMantencion = ['mantencion', 'trabajos_domicilio'].includes(mov.categoria) ? mov.monto : 0;
        let gastosAdministracion = mov.categoria === 'insumos_oficina' ? mov.monto : 0;
        let gastosMejoramiento = ['materiales_red', 'mejoramiento'].includes(mov.categoria) ? mov.monto : 0;
        let otrosEgresos = mov.categoria === 'viaticos' ? mov.monto : 0;
        let depositos = mov.categoria === 'deposito' ? mov.monto : 0;
        
        fila.innerHTML = `
          <td>${botonEditar}</td>
          <td>${mov.fecha}</td>
          <td>${mov.descripcion}</td>
          <td></td><td></td><td></td><td></td><td></td>
          <td class="egreso-cell">${formatearMoneda(energiaElectrica)}</td>
          <td class="egreso-cell">${formatearMoneda(sueldos)}</td>
          <td class="egreso-cell">${formatearMoneda(otrosGastosOperacion)}</td>
          <td class="egreso-cell">${formatearMoneda(gastosMantencion)}</td>
          <td class="egreso-cell">${formatearMoneda(gastosAdministracion)}</td>
          <td class="egreso-cell">${formatearMoneda(gastosMejoramiento)}</td>
          <td class="egreso-cell">${formatearMoneda(otrosEgresos)}</td>
          <td class="egreso-cell">${formatearMoneda(depositos)}</td>
          <td class="egreso-cell">${formatearMoneda(mov.monto)}</td>
        `;
      } else if (mov.tipo === 'transferencia' && mov.subtipo === 'giro') {
        fila.innerHTML = `
          <td>${botonEditar}</td>
          <td>${mov.fecha}</td>
          <td>${mov.detalle}</td>
          <td></td>
          <td></td>
          <td></td>
          <td class="ingreso-cell">${formatearMoneda(mov.monto)}</td>
          <td class="ingreso-cell">${formatearMoneda(mov.monto)}</td>
          <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
          <td></td>
        `;
      } else if (mov.tipo === 'transferencia' && mov.subtipo === 'deposito') {
        fila.innerHTML = `
          <td>${botonEditar}</td>
          <td>${mov.fecha}</td>
          <td>${mov.detalle}</td>
          <td></td><td></td><td></td><td></td><td></td>
          <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
          <td class="egreso-cell">${formatearMoneda(mov.monto)}</td>
          <td class="egreso-cell">${formatearMoneda(mov.monto)}</td>
        `;
      }
      
      tabla.appendChild(fila);
    });
  }

  // Función para actualizar la tabla de todos los movimientos
  function actualizarTablaMovimientos() {
    const tabla = document.getElementById('tablaTodosMovimientos');
    tabla.innerHTML = '';
    
    if (movimientos.length === 0) {
      const fila = document.createElement('tr');
      fila.innerHTML = `<td colspan="9" style="text-align: center; padding: 20px;">No hay movimientos registrados</td>`;
      tabla.appendChild(fila);
      return;
    }

    // Ordenar movimientos por fecha (más reciente primero)
    const movimientosOrdenados = [...movimientos].sort((a, b) => new Date(b.fecha) - new Date(a.fecha));
    
    movimientosOrdenados.forEach(mov => {
      const fila = document.createElement('tr');
      
      let tipo = '';
      let categoria = '';
      
      if (mov.tipo === 'ingreso') {
        tipo = 'Ingreso';
        categoria = categoriasIngresos[mov.categoria] || mov.categoria;
      } else if (mov.tipo === 'egreso') {
        tipo = 'Egreso';
        categoria = categoriasEgresos[mov.categoria] || mov.categoria;
      } else if (mov.tipo === 'transferencia') {
        tipo = mov.subtipo === 'giro' ? 'Giro' : 'Depósito';
        categoria = 'Transferencia';
      }
      
      fila.innerHTML = `
        <td>${mov.fecha}</td>
        <td>${tipo}</td>
        <td>${categoria}</td>
        <td>${mov.descripcion || mov.detalle || ''}</td>
        <td>${cuentas[mov.cuenta] || mov.cuenta || ''}</td>
        <td class="${tipo === 'Ingreso' || tipo === 'Giro' ? 'ingreso-cell' : 'egreso-cell'}">${formatearMoneda(mov.monto)}</td>
        <td>${mov.nro_dcto || ''}</td>
        <td>${mov.proveedor || mov.razon_social || ''}</td>
        <td>${mov.rut_proveedor || ''}</td>
      `;
      
      tabla.appendChild(fila);
    });
  }

  // Función para filtrar movimientos
  function filtrarMovimientos() {
    const tipo = document.getElementById('filtroTipo').value;
    const categoria = document.getElementById('filtroCategoria').value;
    const cuenta = document.getElementById('filtroCuenta').value;
    const fechaDesde = document.getElementById('filtroFechaDesde').value;
    const fechaHasta = document.getElementById('filtroFechaHasta').value;
    
    let movimientosFiltrados = [...movimientos];
    
    if (tipo) {
      movimientosFiltrados = movimientosFiltrados.filter(mov => {
        if (tipo === 'transferencia') {
          return mov.tipo === 'transferencia';
        }
        return mov.tipo === tipo;
      });
    }
    
    if (categoria) {
      movimientosFiltrados = movimientosFiltrados.filter(mov => {
        if (mov.tipo === 'ingreso') {
          return categoriasIngresos[mov.categoria] === categoria;
        } else if (mov.tipo === 'egreso') {
          return categoriasEgresos[mov.categoria] === categoria;
        }
        return false;
      });
    }
    
    if (cuenta) {
      movimientosFiltrados = movimientosFiltrados.filter(mov => {
        if (mov.tipo === 'transferencia') {
          return mov.cuenta_origen === cuenta || mov.cuenta_destino === cuenta;
        }
        return mov.cuenta === cuenta;
      });
    }
    
    if (fechaDesde) {
      movimientosFiltrados = movimientosFiltrados.filter(mov => mov.fecha >= fechaDesde);
    }
    
    if (fechaHasta) {
      movimientosFiltrados = movimientosFiltrados.filter(mov => mov.fecha <= fechaHasta);
    }
    
    // Actualizar la tabla con los movimientos filtrados
    const tabla = document.getElementById('tablaTodosMovimientos');
    tabla.innerHTML = '';
    
    if (movimientosFiltrados.length === 0) {
      const fila = document.createElement('tr');
      fila.innerHTML = `<td colspan="9" style="text-align: center; padding: 20px;">No hay movimientos que coincidan con los filtros</td>`;
      tabla.appendChild(fila);
      return;
    }
    
    movimientosFiltrados.forEach(mov => {
      const fila = document.createElement('tr');
      
      let tipo = '';
      let categoria = '';
      
      if (mov.tipo === 'ingreso') {
        tipo = 'Ingreso';
        categoria = categoriasIngresos[mov.categoria] || mov.categoria;
      } else if (mov.tipo === 'egreso') {
        tipo = 'Egreso';
        categoria = categoriasEgresos[mov.categoria] || mov.categoria;
      } else if (mov.tipo === 'transferencia') {
        tipo = mov.subtipo === 'giro' ? 'Giro' : 'Depósito';
        categoria = 'Transferencia';
      }
      
      fila.innerHTML = `
        <td>${mov.fecha}</td>
        <td>${tipo}</td>
        <td>${categoria}</td>
        <td>${mov.descripcion || mov.detalle || ''}</td>
        <td>${cuentas[mov.cuenta] || mov.cuenta || ''}</td>
        <td class="${tipo === 'Ingreso' || tipo === 'Giro' ? 'ingreso-cell' : 'egreso-cell'}">${formatearMoneda(mov.monto)}</td>
        <td>${mov.nro_dcto || ''}</td>
        <td>${mov.proveedor || mov.razon_social || ''}</td>
        <td>${mov.rut_proveedor || ''}</td>
      `;
      
      tabla.appendChild(fila);
    });
  }

  // Función para exportar a Excel
  function exportarExcel() {
    // Obtener los datos filtrados
    const tipo = document.getElementById('filtroTipo').value;
    const categoria = document.getElementById('filtroCategoria').value;
    const cuenta = document.getElementById('filtroCuenta').value;
    const fechaDesde = document.getElementById('filtroFechaDesde').value;
    const fechaHasta = document.getElementById('filtroFechaHasta').value;
    
    let movimientosFiltrados = [...movimientos];
    
    if (tipo) {
      movimientosFiltrados = movimientosFiltrados.filter(mov => {
        if (tipo === 'transferencia') {
          return mov.tipo === 'transferencia';
        }
        return mov.tipo === tipo;
      });
    }
    
    if (categoria) {
      movimientosFiltrados = movimientosFiltrados.filter(mov => {
        if (mov.tipo === 'ingreso') {
          return categoriasIngresos[mov.categoria] === categoria;
        } else if (mov.tipo === 'egreso') {
          return categoriasEgresos[mov.categoria] === categoria;
        }
        return false;
      });
    }
    
    if (cuenta) {
      movimientosFiltrados = movimientosFiltrados.filter(mov => {
        if (mov.tipo === 'transferencia') {
          return mov.cuenta_origen === cuenta || mov.cuenta_destino === cuenta;
        }
        return mov.cuenta === cuenta;
      });
    }
    
    if (fechaDesde) {
      movimientosFiltrados = movimientosFiltrados.filter(mov => mov.fecha >= fechaDesde);
    }
    
    if (fechaHasta) {
      movimientosFiltrados = movimientosFiltrados.filter(mov => mov.fecha <= fechaHasta);
    }
    
    // Preparar los datos para el Excel
    const datos = movimientosFiltrados.map(mov => {
      let tipo = '';
      let categoria = '';
      
      if (mov.tipo === 'ingreso') {
        tipo = 'Ingreso';
        categoria = categoriasIngresos[mov.categoria] || mov.categoria;
      } else if (mov.tipo === 'egreso') {
        tipo = 'Egreso';
        categoria = categoriasEgresos[mov.categoria] || mov.categoria;
      } else if (mov.tipo === 'transferencia') {
        tipo = mov.subtipo === 'giro' ? 'Giro' : 'Depósito';
        categoria = 'Transferencia';
      }
      
      return {
        'Fecha': mov.fecha,
        'Tipo': tipo,
        'Categoría': categoria,
        'Descripción': mov.descripcion || mov.detalle || '',
        'Cuenta': cuentas[mov.cuenta] || mov.cuenta || '',
        'Monto': mov.monto,
        'N° Comprobante': mov.nro_dcto || '',
        'Proveedor': mov.proveedor || mov.razon_social || '',
        'RUT Proveedor': mov.rut_proveedor || ''
      };
    });
    
    // Crear el libro de Excel
    const libro = XLSX.utils.book_new();
    const hoja = XLSX.utils.json_to_sheet(datos);
    XLSX.utils.book_append_sheet(libro, hoja, "Movimientos");
    
    // Generar el archivo Excel
    const fecha = new Date().toISOString().slice(0, 10);
    XLSX.writeFile(libro, `movimientos_${fecha}.xlsx`);
    
    mostrarNotificacion('Archivo Excel generado exitosamente');
  }

  function editarMovimiento(id) {
    // Convertir el ID a número (por si viene como string)
    id = typeof id === 'string' ? parseInt(id) : id;
// Buscar el movimiento
    const movimiento = movimientos.find(m => m.id === id);
    
    if (!movimiento) {
        mostrarNotificacion('Movimiento no encontrado');
        return;
    }
// Asignar el movimiento a editar
    movimientoEditando = movimiento;
    
// Mostrar el modal correspondiente según el tipo de movimiento
    if (movimiento.tipo === 'ingreso') {

      // Llenar el formulario de ingresos
        document.getElementById('fecha-ingresos').value = movimiento.fecha;
        document.getElementById('nro-dcto-ingresos').value = movimiento.nro_dcto || '';
        document.getElementById('categoria-ingresos').value = movimiento.categoria;
        document.getElementById('cuenta-destino').value = movimiento.cuenta;
        document.getElementById('descripcion-ingresos').value = movimiento.descripcion || '';
        document.getElementById('monto-ingresos').value = movimiento.monto;
      
      // Mostrar modal de ingresos
      document.getElementById('ingresosModal').classList.add('show');
    } else if (movimiento.tipo === 'egreso') {
      // Llenar el formulario de egresos con los datos del movimiento
      document.getElementById('fecha-egresos').value = movimiento.fecha;
      document.getElementById('nro-dcto-egresos').value = movimiento.nro_dcto;
      document.getElementById('categoria-egresos').value = movimiento.categoria;
      document.getElementById('cuenta-origen').value = movimiento.cuenta;
      document.getElementById('razon_social').value = movimiento.proveedor || '';
      document.getElementById('rut').value = movimiento.rut_proveedor || '';
      document.getElementById('descripcion-egresos').value = movimiento.descripcion;
      document.getElementById('monto-egresos').value = movimiento.monto;
      
      // Mostrar modal de egresos
      document.getElementById('egresosModal').classList.add('show');
    }
  }

  // Función para actualizar el balance
  function actualizarBalance() {
    const balanceIngresos = document.getElementById('balanceIngresos');
    const balanceEgresos = document.getElementById('balanceEgresos');
    const balanceMovimientos = document.getElementById('balanceMovimientos');
    
    balanceIngresos.innerHTML = '';
    balanceEgresos.innerHTML = '';
    balanceMovimientos.innerHTML = '';
    
    // Agrupar ingresos por categoría
    const ingresosPorCategoria = {};
    movimientos
      .filter(m => m.tipo === 'ingreso')
      .forEach(mov => {
        const categoria = categoriasIngresos[mov.categoria] || mov.categoria;
        ingresosPorCategoria[categoria] = (ingresosPorCategoria[categoria] || 0) + mov.monto;
      });
    
    // Agregar ingresos al balance
    Object.entries(ingresosPorCategoria).forEach(([categoria, monto]) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="category">${categoria}</span>
        <span class="amount ingreso">${formatearMoneda(monto)}</span>
      `;
      balanceIngresos.appendChild(li);
    });
    
    // Agrupar egresos por categoría
    const egresosPorCategoria = {};
    movimientos
      .filter(m => m.tipo === 'egreso')
      .forEach(mov => {
        const categoria = categoriasEgresos[mov.categoria] || mov.categoria;
        egresosPorCategoria[categoria] = (egresosPorCategoria[categoria] || 0) + mov.monto;
      });
    
    // Agregar egresos al balance
    Object.entries(egresosPorCategoria).forEach(([categoria, monto]) => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="category">${categoria}</span>
        <span class="amount egreso">${formatearMoneda(monto)}</span>
      `;
      balanceEgresos.appendChild(li);
    });
    
    // Agregar últimos movimientos (últimos 5)
    const ultimosMovimientos = [...movimientos]
      .sort((a, b) => new Date(b.fecha) - new Date(a.fecha))
      .slice(0, 5);
    
    ultimosMovimientos.forEach(mov => {
      const li = document.createElement('li');
      const tipo = mov.tipo === 'ingreso' ? 'Ingreso' : (mov.tipo === 'egreso' ? 'Egreso' : 'Transferencia');
      const clase = mov.tipo === 'ingreso' ? 'ingreso' : 'egreso';
      
      li.innerHTML = `
        <span class="category">${tipo}: ${mov.descripcion || mov.detalle || ''}</span>
        <span class="amount ${clase}">${formatearMoneda(mov.monto)}</span>
      `;
      balanceMovimientos.appendChild(li);
    });
    
    // Actualizar análisis financiero
    const totalIngresos = Object.values(ingresosPorCategoria).reduce((a, b) => a + b, 0);
    const totalEgresos = Object.values(egresosPorCategoria).reduce((a, b) => a + b, 0);
    const flujoEfectivo = totalIngresos - totalEgresos;
    const proporcion = totalIngresos > 0 ? (totalEgresos / totalIngresos).toFixed(2) : 0;
    const porcentajeAhorro = totalIngresos > 0 ? ((flujoEfectivo / totalIngresos) * 100).toFixed(2) : 0;
    
    document.getElementById('flujoEfectivo').textContent = formatearMoneda(flujoEfectivo);
    document.getElementById('proporcionIngEgr').textContent = `1:${proporcion}`;
    document.getElementById('porcentajeAhorro').textContent = `${porcentajeAhorro}%`;
    
    document.getElementById('flujoBar').style.width = `${Math.min(100, Math.max(0, (flujoEfectivo / totalIngresos) * 100))}%`;
    document.getElementById('proporcionBar').style.width = `${Math.min(100, proporcion * 100)}%`;
    document.getElementById('ahorroBar').style.width = `${Math.min(100, porcentajeAhorro)}%`;
    
    // Actualizar gráficos
    inicializarGraficos();
  }

  // Función para actualizar el informe por rubro
  function actualizarInformeRubro() {
    // Calcular gastos operativos (mantención, materiales, trabajos domicilio)
    const gastoOperativo = movimientos
      .filter(m => m.tipo === 'egreso' && 
        (m.categoria === 'mantencion' || m.categoria === 'trabajos_domicilio' || m.categoria === 'materiales_red'))
      .reduce((total, m) => total + m.monto, 0);
    
    // Calcular gastos administrativos (sueldos, administración, energía, etc.)
    const gastoAdministrativo = movimientos
      .filter(m => m.tipo === 'egreso' && 
        (m.categoria === 'sueldos' || m.categoria === 'insumos_oficina' || m.categoria === 'energia_electrica' || 
         m.categoria === 'otras_cuentas' || m.categoria === 'viaticos'))
      .reduce((total, m) => total + m.monto, 0);
    
    // Calcular gasto en mantención
    const gastoMantencion = movimientos
      .filter(m => m.tipo === 'egreso' && (m.categoria === 'mantencion' || m.categoria === 'trabajos_domicilio'))
      .reduce((total, m) => total + m.monto, 0);
    
    // Calcular recaudado por multas (asumiendo que las multas son ingresos con categoría específica)
    const recaudoMultas = movimientos
      .filter(m => m.tipo === 'ingreso' && (m.categoria === 'multas_inasistencia' || m.categoria === 'otras_multas'))
      .reduce((total, m) => total + m.monto, 0);
    
    // Actualizar la interfaz
    document.getElementById('gastoOperativo').textContent = formatearMoneda(gastoOperativo);
    document.getElementById('gastoAdministrativo').textContent = formatearMoneda(gastoAdministrativo);
    document.getElementById('gastoMantencion').textContent = formatearMoneda(gastoMantencion);
    document.getElementById('recaudoMultas').textContent = formatearMoneda(recaudoMultas);
    
    // Actualizar barras de progreso
    const totalOperAdmin = gastoOperativo + gastoAdministrativo;
    const porcentajeOperativo = totalOperAdmin > 0 ? (gastoOperativo / totalOperAdmin) * 100 : 50;
    const porcentajeMantencionMultas = (gastoMantencion + recaudoMultas) > 0 ? 
      (gastoMantencion / (gastoMantencion + recaudoMultas)) * 100 : 50;
    
    document.querySelectorAll('.rubro-bar-fill')[0].style.width = `${porcentajeOperativo}%`;
    document.querySelectorAll('.rubro-bar-fill')[1].style.width = `${porcentajeMantencionMultas}%`;
    
    // Actualizar valores en los títulos
    document.querySelectorAll('.rubro-value')[0].textContent = 
      `${formatearMoneda(gastoOperativo)} / ${formatearMoneda(gastoAdministrativo)}`;
    document.querySelectorAll('.rubro-value')[1].textContent = 
      `${formatearMoneda(gastoMantencion)} / ${formatearMoneda(recaudoMultas)}`;
  }

  // Función para generar número de comprobante secuencial
  function generarNumeroComprobante() {
    const numero = comprobanteCounter.toString().padStart(4, '0');
    comprobanteCounter++;
    localStorage.setItem('comprobanteCounter', comprobanteCounter);
    return `CMP-${numero}`;
  }

  // Función para mostrar notificaciones
  function mostrarNotificacion(mensaje) {
    const notification = document.getElementById('notification');
    notification.textContent = mensaje;
    notification.style.display = 'block';
    
    setTimeout(() => {
      notification.style.display = 'none';
    }, 3000);
  }

  // Función para volver a la vista de registro principal
  function volverARegistro() {
    document.getElementById('girosDepositosSection').style.display = 'none';
    document.getElementById('libroCajaSection').style.display = 'none';
    document.getElementById('balanceSection').style.display = 'none';
    document.getElementById('conciliacionSection').style.display = 'none';
    document.getElementById('informeRubroSection').style.display = 'none';
    document.getElementById('movimientosSection').style.display = 'none';
    document.getElementById('registroSection').style.display = 'block';
  }

  // Función para registrar un ingreso
  function registrarIngreso(e) {
    e.preventDefault();
    // Forzar la fecha actual en el registro
    const fecha = obtenerFechaActual();
    document.getElementById('fecha-ingresos').value = fecha;
    const nro_dcto = document.getElementById('nro-dcto-ingresos').value;
    const categoria = document.getElementById('categoria-ingresos').value;
    const cuenta_destino = document.getElementById('cuenta-destino').value;
    const descripcion = document.getElementById('descripcion-ingresos').value;
    const monto = parseFloat(document.getElementById('monto-ingresos').value);
    
    // Validaciones
    if (isNaN(monto) || monto <= 0) {
      mostrarNotificacion('Ingrese un monto válido y positivo');
      return;
    }

    // Si estamos editando un movimiento
    if (movimientoEditando) {
      // Restar el monto anterior del saldo
      saldosCuentas[movimientoEditando.cuenta] -= movimientoEditando.monto;
      
      // Actualizar el movimiento
      movimientoEditando.fecha = fecha;
      movimientoEditando.nro_dcto = nro_dcto;
      movimientoEditando.categoria = categoria;
      movimientoEditando.cuenta = cuenta_destino;
      movimientoEditando.descripcion = descripcion;
      movimientoEditando.monto = monto;
      
      // Sumar el nuevo monto al saldo
      saldosCuentas[cuenta_destino] += monto;
      
      mostrarNotificacion('Movimiento actualizado exitosamente');
      movimientoEditando = null;
    } else {
      // Crear movimiento nuevo
      const movimiento = {
        id: Date.now(),
        tipo: 'ingreso',
        fecha,
        nro_dcto,
        categoria,
        cuenta: cuenta_destino,
        descripcion,
        monto
      };
      
      // Agregar a la lista de movimientos
      movimientos.push(movimiento);
      
      // Actualizar saldo de la cuenta
      saldosCuentas[cuenta_destino] += monto;
      
      mostrarNotificacion('Ingreso registrado exitosamente');
    }
    
    // Guardar cambios
    localStorage.setItem('movimientos', JSON.stringify(movimientos));
    actualizarSaldosCuentas();

    // Actualizar todo
    actualizarTotales();
    actualizarTabla();
    actualizarBalance();
    actualizarTablaMovimientos();

    // Mensaje de éxito
    mostrarNotificacion('¡Ingreso registrado exitosamente!');

    // Deshabilitar el botón de registrar para evitar más registros hasta que se cierre el modal
    const btnRegistrar = document.querySelector('#ingresosForm button[type="submit"]');
    btnRegistrar.disabled = true;

    // Opcional: deshabilitar todos los campos del formulario
    Array.from(document.querySelectorAll('#ingresosForm input, #ingresosForm select, #ingresosForm textarea')).forEach(el => el.disabled = true);

    // Limpiar formulario (opcional, si quieres limpiar después de registrar)
    // document.getElementById('ingresosForm').reset();
}
// Función para obtener la fecha actual en formato yyyy-mm-dd
function obtenerFechaActual() {
  const hoy = new Date();
  const yyyy = hoy.getFullYear();
  const mm = String(hoy.getMonth() + 1).padStart(2, '0');
  const dd = String(hoy.getDate()).padStart(2, '0');
  return `${yyyy}-${mm}-${dd}`;
}
  // Función para generar un comprobante en PDF
  function generarComprobantePDF() {
    const fecha = document.getElementById('fecha-ingresos').value;
    const nro_dcto = document.getElementById('nro-dcto-ingresos').value;
    const categoria = document.getElementById('categoria-ingresos').value;
    const cuenta_destino = document.getElementById('cuenta-destino').value;
    const descripcion = document.getElementById('descripcion-ingresos').value;
    const monto = document.getElementById('monto-ingresos').value;
    
    if (!fecha || !nro_dcto || !categoria || !cuenta_destino || !descripcion || !monto) {
      mostrarNotificacion('Complete todos los campos antes de imprimir');
      return;
    }
    
    // Crear el contenido del comprobante
    const comprobanteHTML = `
      <div class="comprobante-container">
        <div class="comprobante-header">
          <h2 class="comprobante-title">Comprobante de Ingreso</h2>
          <p class="comprobante-subtitle">N° ${nro_dcto}</p>
        </div>
        
        <div class="comprobante-body">
          <div class="comprobante-row">
            <span class="comprobante-label">Fecha:</span>
            <span class="comprobante-value">${fecha}</span>
          </div>
          <div class="comprobante-row">
            <span class="comprobante-label">Categoría:</span>
            <span class="comprobante-value">${categoriasIngresos[categoria] || categoria}</span>
          </div>
          <div class="comprobante-row">
            <span class="comprobante-label">Cuenta Destino:</span>
            <span class="comprobante-value">${cuentas[cuenta_destino] || cuenta_destino}</span>
          </div>
          <div class="comprobante-row">
            <span class="comprobante-label">Descripción:</span>
            <span class="comprobante-value">${descripcion}</span>
          </div>
          <div class="comprobante-row">
            <span class="comprobante-label">Monto:</span>
            <span class="comprobante-value comprobante-total">${formatearMoneda(parseFloat(monto))}</span>
          </div>
        </div>
        
        <div class="comprobante-footer">
          <p>Comprobante generado el ${new Date().toLocaleDateString()}</p>
        </div>
      </div>
    `;
    
    // Insertar el comprobante en el contenedor oculto
    const comprobanteContainer = document.getElementById('comprobantePDF');
    comprobanteContainer.innerHTML = comprobanteHTML;
    
    // Abrir ventana de impresión de Windows con el comprobante
    const printWindow = window.open('', '_blank');
    printWindow.document.write('<html><head><title>Comprobante de Ingreso</title>');
    printWindow.document.write('<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Poppins:400,600&display=swap">');
    printWindow.document.write('<style>body{font-family:Poppins,sans-serif;} .comprobante-container{background:white;padding:30px;border-radius:8px;max-width:600px;margin:0 auto;box-shadow:0 0 10px rgba(0,0,0,0.1);} .comprobante-header{text-align:center;margin-bottom:20px;border-bottom:2px solid #2c5282;padding-bottom:15px;} .comprobante-title{color:#2c5282;font-size:1.8rem;margin-bottom:5px;} .comprobante-subtitle{color:#4a5568;font-size:1.2rem;} .comprobante-body{margin:25px 0;} .comprobante-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #eee;} .comprobante-label{font-weight:600;color:#2d3748;} .comprobante-value{color:#4a5568;} .comprobante-total{font-weight:700;font-size:1.2rem;color:#2c5282;} .comprobante-footer{text-align:center;margin-top:30px;color:#718096;font-size:0.9rem;}</style>');
    printWindow.document.write('</head><body>');
    printWindow.document.write(comprobanteHTML);
    printWindow.document.write('</body></html>');
    printWindow.document.close();
    printWindow.focus();
    setTimeout(() => { printWindow.print(); printWindow.close(); }, 500);
    mostrarNotificacion('Comprobante listo para imprimir');
  }

  // Función para generar un comprobante de egreso en PDF
  function generarComprobanteEgresoPDF() {
    const fecha = document.getElementById('fecha-egresos').value;
    const nro_dcto = document.getElementById('nro-dcto-egresos').value;
    const categoria = document.getElementById('categoria-egresos').value;
    const cuenta_origen = document.getElementById('cuenta-origen').value;
    const razon_social = document.getElementById('razon_social').value;
    const rut_proveedor = document.getElementById('rut').value;
    const descripcion = document.getElementById('descripcion-egresos').value;
    const monto = document.getElementById('monto-egresos').value;
    
    if (!fecha || !nro_dcto || !categoria || !cuenta_origen || !razon_social || !descripcion || !monto) {
      mostrarNotificacion('Complete todos los campos antes de imprimir');
      return;
    }
    
    // Crear el contenido del comprobante
    const comprobanteHTML = `
      <div class="comprobante-container">
        <div class="comprobante-header">
          <h2 class="comprobante-title">Comprobante de Egreso</h2>
          <p class="comprobante-subtitle">N° ${nro_dcto}</p>
        </div>
        
        <div class="comprobante-body">
          <div class="comprobante-row">
            <span class="comprobante-label">Fecha:</span>
            <span class="comprobante-value">${fecha}</span>
          </div>
          <div class="comprobante-row">
            <span class="comprobante-label">Categoría:</span>
            <span class="comprobante-value">${categoriasEgresos[categoria] || categoria}</span>
          </div>
          <div class="comprobante-row">
            <span class="comprobante-label">Cuenta Origen:</span>
            <span class="comprobante-value">${cuentas[cuenta_origen] || cuenta_origen}</span>
          </div>
          <div class="comprobante-row">
            <span class="comprobante-label">Proveedor:</span>
            <span class="comprobante-value">${razon_social}</span>
          </div>
          <div class="comprobante-row">
            <span class="comprobante-label">RUT Proveedor:</span>
            <span class="comprobante-value">${rut_proveedor || 'No especificado'}</span>
          </div>
          <div class="comprobante-row">
            <span class="comprobante-label">Descripción:</span>
            <span class="comprobante-value">${descripcion}</span>
          </div>
          <div class="comprobante-row">
            <span class="comprobante-label">Monto:</span>
            <span class="comprobante-value comprobante-total">${formatearMoneda(parseFloat(monto))}</span>
          </div>
        </div>
        
        <div class="comprobante-footer">
          <p>Comprobante generado el ${new Date().toLocaleDateString()}</p>
        </div>
      </div>
    `;
    
    // Insertar el comprobante en el contenedor oculto
    const comprobanteContainer = document.getElementById('comprobantePDF');
    comprobanteContainer.innerHTML = comprobanteHTML;
    
    // Generar el PDF
    html2canvas(comprobanteContainer, {
      scale: 2,
      useCORS: true
    }).then(canvas => {
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
      const imgWidth = 210;
      const imgHeight = canvas.height * imgWidth / canvas.width;
      
      pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
      pdf.save(`comprobante_egreso_${nro_dcto}.pdf`);
      
      mostrarNotificacion('Comprobante generado exitosamente');
    });
  }

  // Función para registrar un egreso
  function registrarEgreso(e) {
    e.preventDefault();
    
    const fecha = document.getElementById('fecha-egresos').value;
    const nro_dcto = document.getElementById('nro-dcto-egresos').value;
    const categoria = document.getElementById('categoria-egresos').value;
    const cuenta_origen = document.getElementById('cuenta-origen').value;
    const razon_social = document.getElementById('razon_social').value;
    const rut_proveedor = document.getElementById('rut').value;
    const descripcion = document.getElementById('descripcion-egresos').value;
    const monto = parseFloat(document.getElementById('monto-egresos').value);
    
    // Validaciones
    if (isNaN(monto) || monto <= 0) {
      mostrarNotificacion('Ingrese un monto válido y positivo');
      return;
    }

    if (saldosCuentas[cuenta_origen] < monto) {
      mostrarNotificacion('Saldo insuficiente en la cuenta seleccionada');
      return;
    }

    // Validar formato de RUT
    if (!validarRut(rut_proveedor)) {
      mostrarNotificacion('El RUT debe tener el formato 11111111-1');
      return;
    }

    // Si estamos editando un movimiento
    if (movimientoEditando) {
      // Sumar el monto anterior al saldo (estamos revirtiendo el egreso)
      saldosCuentas[movimientoEditando.cuenta] += movimientoEditando.monto;
      
      // Actualizar el movimiento
      movimientoEditando.fecha = fecha;
      movimientoEditando.nro_dcto = nro_dcto;
      movimientoEditando.categoria = categoria;
      movimientoEditando.cuenta = cuenta_origen;
      movimientoEditando.proveedor = razon_social;
      movimientoEditando.rut_proveedor = rut_proveedor;
      movimientoEditando.descripcion = descripcion;
      movimientoEditando.monto = monto;
      
      // Restar el nuevo monto del saldo
      saldosCuentas[cuenta_origen] -= monto;
      
      mostrarNotificacion('Movimiento actualizado exitosamente');
      movimientoEditando = null;
    } else {
      // Crear movimiento nuevo
      const movimiento = {
        id: Date.now(),
        tipo: 'egreso',
        fecha,
        nro_dcto,
        categoria,
        cuenta: cuenta_origen,
        proveedor: razon_social,
        rut_proveedor,
        descripcion,
        monto
      };
      
      // Agregar a la lista de movimientos
      movimientos.push(movimiento);
      
      // Actualizar saldo de la cuenta
      saldosCuentas[cuenta_origen] -= monto;
      
      mostrarNotificacion('Egreso registrado exitosamente');
    }
    
    // Guardar cambios
    localStorage.setItem('movimientos', JSON.stringify(movimientos));
    
    // Actualizar todo
    actualizarTotales();
    actualizarTabla();
    actualizarBalance();
    actualizarTablaMovimientos();
    
    // Limpiar formulario (opcional, si quieres limpiar después de registrar)
    // document.getElementById('egresosForm').reset();
  }

  // Función para registrar un giro
  function registrarGiro(e) {
    e.preventDefault();
    
    const fecha = document.getElementById('fecha-giro').value;
    const monto = parseFloat(document.getElementById('monto-giro').value);
    const cuenta_origen = document.getElementById('cuenta-giro').value;
    const detalle = document.getElementById('detalle-giro').value;
    
    // Validar monto
    if (isNaN(monto)) {
      mostrarNotificacion('Ingrese un monto válido');
      return;
    }
    
    // Validar saldo suficiente
    if (saldosCuentas[cuenta_origen] < monto) {
      mostrarNotificacion('Saldo insuficiente en la cuenta seleccionada');
      return;
    }
    
    // Actualizar saldos
    saldosCuentas[cuenta_origen] -= monto;
    saldosCuentas.caja_general += monto;
    actualizarSaldosCuentas();
    
    // Crear movimiento
    const movimiento = {
      id: Date.now(),
      tipo: 'transferencia',
      subtipo: 'giro',
      fecha,
      cuenta_origen,
      cuenta_destino: 'caja_general',
      detalle,
      monto
    };
    
    // Agregar a la lista de movimientos
    movimientos.push(movimiento);
    localStorage.setItem('movimientos', JSON.stringify(movimientos));
    
    // Actualizar todo
    actualizarTotales();
    actualizarTabla();
    actualizarBalance();
    actualizarTablaMovimientos();
    
    // Mostrar notificación
    mostrarNotificacion('Giro registrado exitosamente');
    
    // Limpiar formulario
    document.getElementById('girosForm').reset();
  }

  // Función para registrar un depósito
  function registrarDeposito(e) {
    e.preventDefault();
    
    const fecha = document.getElementById('fecha-deposito').value;
    const monto = parseFloat(document.getElementById('monto-deposito').value);
    const cuenta_destino = document.getElementById('cuenta-deposito').value;
    const detalle = document.getElementById('detalle-deposito').value;
    
    // Validar monto
    if (isNaN(monto)) {
      mostrarNotificacion('Ingrese un monto válido');
      return;
    }
    
    // Validar saldo suficiente
    if (saldosCuentas.caja_general < monto) {
      mostrarNotificacion('Saldo insuficiente en la Caja General');
      return;
    }
    
    // Actualizar saldos
    saldosCuentas.caja_general -= monto;
    saldosCuentas[cuenta_destino] += monto;
    actualizarSaldosCuentas();
    
    // Crear movimiento
    const movimiento = {
      id: Date.now(),
      tipo: 'transferencia',
      subtipo: 'deposito',
      fecha,
      cuenta_origen: 'caja_general',
      cuenta_destino,
      detalle,
      monto
    };
    
    // Agregar a la lista de movimientos
    movimientos.push(movimiento);
    localStorage.setItem('movimientos', JSON.stringify(movimientos));
    
    // Actualizar todo
    actualizarTotales();
    actualizarTabla();
    actualizarBalance();
    actualizarTablaMovimientos();
    
    // Mostrar notificación
    mostrarNotificacion('Depósito registrado exitosamente');
    
    // Limpiar formulario
    document.getElementById('depositosForm').reset();
  }

  // Función para filtrar movimientos por fecha
  function filtrarPorFechas() {
    const fechaDesde = document.getElementById('fechaDesde').value;
    const fechaHasta = document.getElementById('fechaHasta').value;
    
    if (!fechaDesde || !fechaHasta) {
      mostrarNotificacion('Seleccione un rango de fechas');
      return;
    }
    
    // Filtrar movimientos
    const movimientosFiltrados = movimientos.filter(mov => {
      return mov.fecha >= fechaDesde && mov.fecha <= fechaHasta;
    });
    
    // Actualizar tabla con movimientos filtrados
    const tabla = document.getElementById('tablaMovimientos');
    tabla.innerHTML = '';
    
    if (movimientosFiltrados.length === 0) {
      const fila = document.createElement('tr');
      fila.innerHTML = `<td colspan="17" style="text-align: center; padding: 20px;">No hay movimientos en el rango seleccionado</td>`;
      tabla.appendChild(fila);
      return;
    }
    
    // Agregar movimientos filtrados
    movimientosFiltrados.forEach(mov => {
      const fila = document.createElement('tr');
      const botonEditar = `
        <button class="edit-btn" onclick="editarMovimiento('${mov.id}')">
          <i class="bi bi-pencil"></i> Editar
        </button>
      `;

      if (mov.tipo === 'ingreso') {
        let totalConsumo = mov.categoria === 'venta_agua' ? mov.monto : 0;
        let cuotasIncorporacion = mov.categoria === 'cuotas_incorporacion' ? mov.monto : 0;
        let otrosIngresos = ['venta_medidores', 'trabajos_domicilio', 'subsidios', 'otros_aportes', 'multas_inasistencia', 'otras_multas'].includes(mov.categoria) ? mov.monto : 0;
        let giros = mov.categoria === 'giro' ? mov.monto : 0;
        
        fila.innerHTML = `
          <td>${botonEditar}</td>
          <td>${mov.fecha}</td>
          <td>${mov.descripcion}</td>
          <td class="ingreso-cell">${formatearMoneda(totalConsumo)}</td>
          <td class="ingreso-cell">${formatearMoneda(cuotasIncorporacion)}</td>
          <td class="ingreso-cell">${formatearMoneda(otrosIngresos)}</td>
          <td class="ingreso-cell">${formatearMoneda(giros)}</td>
          <td class="ingreso-cell">${formatearMoneda(mov.monto)}</td>
          <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
          <td></td>
        `;
      } else if (mov.tipo === 'egreso') {
        let energiaElectrica = mov.categoria === 'energia_electrica' ? mov.monto : 0;
        let sueldos = mov.categoria === 'sueldos' ? mov.monto : 0;
        let otrosGastosOperacion = mov.categoria === 'otras_cuentas' ? mov.monto : 0;
        let gastosMantencion = ['mantencion', 'trabajos_domicilio'].includes(mov.categoria) ? mov.monto : 0;
        let gastosAdministracion = mov.categoria === 'insumos_oficina' ? mov.monto : 0;
        let gastosMejoramiento = ['materiales_red', 'mejoramiento'].includes(mov.categoria) ? mov.monto : 0;
        let otrosEgresos = mov.categoria === 'viaticos' ? mov.monto : 0;
        let depositos = mov.categoria === 'deposito' ? mov.monto : 0;
        
        fila.innerHTML = `
          <td>${botonEditar}</td>
          <td>${mov.fecha}</td>
          <td>${mov.descripcion}</td>
          <td></td><td></td><td></td><td></td><td></td>
          <td class="egreso-cell">${formatearMoneda(energiaElectrica)}</td>
          <td class="egreso-cell">${formatearMoneda(sueldos)}</td>
          <td class="egreso-cell">${formatearMoneda(otrosGastosOperacion)}</td>
          <td class="egreso-cell">${formatearMoneda(gastosMantencion)}</td>
          <td class="egreso-cell">${formatearMoneda(gastosAdministracion)}</td>
          <td class="egreso-cell">${formatearMoneda(gastosMejoramiento)}</td>
          <td class="egreso-cell">${formatearMoneda(otrosEgresos)}</td>
          <td class="egreso-cell">${formatearMoneda(depositos)}</td>
          <td class="egreso-cell">${formatearMoneda(mov.monto)}</td>
        `;
      } else if (mov.tipo === 'transferencia' && mov.subtipo === 'giro') {
        fila.innerHTML = `
          <td>${botonEditar}</td>
          <td>${mov.fecha}</td>
          <td>${mov.detalle}</td>
          <td></td>
          <td></td>
          <td></td>
          <td class="ingreso-cell">${formatearMoneda(mov.monto)}</td>
          <td class="ingreso-cell">${formatearMoneda(mov.monto)}</td>
          <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
          <td></td>
        `;
      } else if (mov.tipo === 'transferencia' && mov.subtipo === 'deposito') {
        fila.innerHTML = `
          <td>${botonEditar}</td>
          <td>${mov.fecha}</td>
          <td>${mov.detalle}</td>
          <td></td><td></td><td></td><td></td><td></td>
          <td></td><td></td><td></td><td></td><td></td><td></td><td></td>
          <td class="egreso-cell">${formatearMoneda(mov.monto)}</td>
          <td class="egreso-cell">${formatearMoneda(mov.monto)}</td>
        `;
      }
      
      tabla.appendChild(fila);
    });
  }

  // Función para inicializar gráficos
  function inicializarGraficos() {
    // --- Gráfico de Ingresos y Egresos por Categoría (ya existente) ---
    const ingresosPorCategoria = {};
    const egresosPorCategoria = {};
    movimientos.forEach(mov => {
      if (mov.tipo === 'ingreso') {
        const categoria = categoriasIngresos[mov.categoria] || mov.categoria;
        ingresosPorCategoria[categoria] = (ingresosPorCategoria[categoria] || 0) + mov.monto;
      } else if (mov.tipo === 'egreso') {
        const categoria = categoriasEgresos[mov.categoria] || mov.categoria;
        egresosPorCategoria[categoria] = (egresosPorCategoria[categoria] || 0) + mov.monto;
      }
    });
    // Ingresos
    const ctxIngresos = document.getElementById('ingresosChart').getContext('2d');
    if (chartIngresos) chartIngresos.destroy();
    chartIngresos = new Chart(ctxIngresos, {
      type: 'pie',
      data: {
        labels: Object.keys(ingresosPorCategoria),
        datasets: [{
          data: Object.values(ingresosPorCategoria),
          backgroundColor: [
            '#4CAF50', '#8BC34A', '#CDDC39', '#FFEB3B', '#FFC107'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });
    // Egresos
    const ctxEgresos = document.getElementById('egresosChart').getContext('2d');
    if (chartEgresos) chartEgresos.destroy();
    chartEgresos = new Chart(ctxEgresos, {
      type: 'pie',
      data: {
        labels: Object.keys(egresosPorCategoria),
        datasets: [{
          data: Object.values(egresosPorCategoria),
          backgroundColor: [
            '#F44336', '#E91E63', '#9C27B0', '#673AB7', '#3F51B5'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false
      }
    });

    // --- Gráfico de Flujo Mensual (Barras) ---
    // Agrupar ingresos y egresos por mes
    const meses = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
    const ingresosMensuales = Array(12).fill(0);
    const egresosMensuales = Array(12).fill(0);
    movimientos.forEach(mov => {
      const fecha = new Date(mov.fecha);
      const mes = fecha.getMonth();
      if (mov.tipo === 'ingreso') ingresosMensuales[mes] += mov.monto;
      if (mov.tipo === 'egreso') egresosMensuales[mes] += mov.monto;
    });
    const ctxFlujo = document.getElementById('flujoChart').getContext('2d');
    if (chartFlujo) chartFlujo.destroy();
    chartFlujo = new Chart(ctxFlujo, {
      type: 'bar',
      data: {
        labels: meses,
        datasets: [
          {
            label: 'Ingresos',
            data: ingresosMensuales,
            backgroundColor: 'rgba(76, 175, 80, 0.7)'
          },
          {
            label: 'Egresos',
            data: egresosMensuales,
            backgroundColor: 'rgba(244, 67, 54, 0.7)'
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    // --- Gráfico de Conciliación Bancaria ---
    // Simulación: movimientos registrados vs extracto bancario
    // Suponiendo que hay un array global extractoBancario (si no, usar solo movimientos)
    let extractoBancario = [];
    try {
      extractoBancario = JSON.parse(localStorage.getItem('extractoBancario')) || [];
    } catch (e) { extractoBancario = []; }
    // Sumar totales
    const totalRegistrado = movimientos.reduce((acc, mov) => acc + (mov.tipo === 'ingreso' ? mov.monto : -mov.monto), 0);
    const totalExtracto = extractoBancario.reduce((acc, mov) => acc + mov.monto, 0);
    const diferencia = totalRegistrado - totalExtracto;
    const ctxConciliacion = document.getElementById('conciliacionChart').getContext('2d');
    if (chartConciliacion) chartConciliacion.destroy();
    chartConciliacion = new Chart(ctxConciliacion, {
      type: 'bar',
      data: {
        labels: ['Registrado', 'Extracto', 'Diferencia'],
        datasets: [{
          label: 'Conciliación',
          data: [totalRegistrado, totalExtracto, diferencia],
          backgroundColor: [
            'rgba(33, 150, 243, 0.7)',
            'rgba(255, 193, 7, 0.7)',
            diferencia >= 0 ? 'rgba(76, 175, 80, 0.7)' : 'rgba(244, 67, 54, 0.7)'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: { beginAtZero: true }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  }

  // Función para exportar a PDF
  function exportarPDF(tipo) {
    mostrarNotificacion(`Exportando ${tipo} a PDF...`);
  }

  // Inicialización al cargar la página
  document.addEventListener('DOMContentLoaded', function() {
    // Configurar eventos para botones principales
    document.getElementById('ingresosBtn').addEventListener('click', () => {
      document.getElementById('ingresosModal').classList.add('show');
      document.getElementById('nro-dcto-ingresos').value = generarNumeroComprobante();
      document.getElementById('cuenta-destino').disabled = false;
      // Establecer fecha actual siempre
      document.getElementById('fecha-ingresos').value = obtenerFechaActual();
    });

    document.getElementById('egresosBtn').addEventListener('click', () => {
      document.getElementById('egresosModal').classList.add('show');
      document.getElementById('nro-dcto-egresos').value = generarNumeroComprobante();
      document.getElementById('cuenta-origen').disabled = false;
      
      // Establecer fecha actual
      const hoy = new Date();
      const fechaHoy = hoy.toISOString().split('T')[0];
      document.getElementById('fecha-egresos').value = fechaHoy;
    });

    document.getElementById('giroDepositosBtn').addEventListener('click', () => {
      document.getElementById('girosDepositosSection').style.display = 'block';
      document.getElementById('registroSection').style.display = 'none';
      // Establecer fecha actual en ambos formularios
      if (document.getElementById('fecha-giro')) {
        document.getElementById('fecha-giro').value = obtenerFechaActual();
      }
      if (document.getElementById('fecha-deposito')) {
        document.getElementById('fecha-deposito').value = obtenerFechaActual();
      }
    });

    document.getElementById('libroCajaBtn').addEventListener('click', () => {
      document.getElementById('registroSection').style.display = 'none';
      document.getElementById('libroCajaSection').style.display = 'block';
      
      // Configurar fechas por defecto (primer y último día del mes actual)
      const hoy = new Date();
      const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const ultimoDiaMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
      
      document.getElementById('fechaDesde').valueAsDate = primerDiaMes;
      document.getElementById('fechaHasta').valueAsDate = ultimoDiaMes;
    });

    document.getElementById('balanceBtn').addEventListener('click', () => {
      document.getElementById('registroSection').style.display = 'none';
      document.getElementById('balanceSection').style.display = 'block';
      inicializarGraficos();
    });

    document.getElementById('conciliacionBtn').addEventListener('click', () => {
      document.getElementById('registroSection').style.display = 'none';
      document.getElementById('conciliacionSection').style.display = 'block';
    });

    document.getElementById('informeRubroBtn').addEventListener('click', () => {
      document.getElementById('registroSection').style.display = 'none';
      document.getElementById('informeRubroSection').style.display = 'block';
    });

    document.getElementById('movimientosBtn').addEventListener('click', () => {
      document.getElementById('registroSection').style.display = 'none';
      document.getElementById('movimientosSection').style.display = 'block';
      
      // Llenar el select de categorías
      const selectCategoria = document.getElementById('filtroCategoria');
      selectCategoria.innerHTML = '<option value="">Todas</option>';
      
      // Agregar categorías de ingresos
      Object.values(categoriasIngresos).forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        selectCategoria.appendChild(option);
      });
      
      // Agregar categorías de egresos
      Object.values(categoriasEgresos).forEach(cat => {
        const option = document.createElement('option');
        option.value = cat;
        option.textContent = cat;
        selectCategoria.appendChild(option);
      });
      
      // Configurar fechas por defecto (primer y último día del mes actual)
      const hoy = new Date();
      const primerDiaMes = new Date(hoy.getFullYear(), hoy.getMonth(), 1);
      const ultimoDiaMes = new Date(hoy.getFullYear(), hoy.getMonth() + 1, 0);
      
      document.getElementById('filtroFechaDesde').valueAsDate = primerDiaMes;
      document.getElementById('filtroFechaHasta').valueAsDate = ultimoDiaMes;
      
      // Actualizar tabla de movimientos
      actualizarTablaMovimientos();
    });

    // Event listeners para cierre de modales
    document.getElementById('closeIngresosModal').addEventListener('click', () => {
      document.getElementById('ingresosModal').classList.remove('show');
      movimientoEditando = null;
      document.getElementById('ingresosForm').reset();
    });

    document.getElementById('closeEgresosModal').addEventListener('click', () => {
      document.getElementById('egresosModal').classList.remove('show');
      document.getElementById('egresosForm').reset();
    });

    // Event listeners para formularios
    document.getElementById('ingresosForm').addEventListener('submit', registrarIngreso);
    document.getElementById('egresosForm').addEventListener('submit', registrarEgreso);
    document.getElementById('girosForm').addEventListener('submit', registrarGiro);
    document.getElementById('depositosForm').addEventListener('submit', registrarDeposito);
    
    // Event listener para imprimir comprobante
    // Deshabilitar los botones de imprimir al inicio
    document.getElementById('imprimirComprobanteBtn').disabled = true;
    document.getElementById('imprimirComprobanteEgresoBtn').disabled = true;

    // Habilitar botón imprimir solo si todos los campos requeridos están llenos en ingresos
    const ingresosForm = document.getElementById('ingresosForm');
    ingresosForm.addEventListener('input', function() {
      let valido = ingresosForm.checkValidity();
      document.getElementById('imprimirComprobanteBtn').disabled = !valido;
      // Asegura que el botón Registrar Ingreso nunca se deshabilite
      ingresosForm.querySelector('button[type="submit"]').disabled = false;
    });
    // Habilitar botón imprimir solo si todos los campos requeridos están llenos en egresos
    const egresosForm = document.getElementById('egresosForm');
    egresosForm.addEventListener('input', function() {
      let valido = egresosForm.checkValidity();
      document.getElementById('imprimirComprobanteEgresoBtn').disabled = !valido;
    });

    document.getElementById('imprimirComprobanteBtn').addEventListener('click', generarComprobantePDF);
    document.getElementById('imprimirComprobanteEgresoBtn').addEventListener('click', generarComprobanteEgresoPDF);

    // Event listeners para botones de volver
    document.getElementById('volverBtn').addEventListener('click', volverARegistro);
    document.getElementById('volverBalanceBtn').addEventListener('click', volverARegistro);
    document.getElementById('volverConciliacionBtn').addEventListener('click', volverARegistro);
    document.getElementById('volverInformeRubroBtn').addEventListener('click', volverARegistro);
    document.getElementById('volverGirosDepositosBtn').addEventListener('click', volverARegistro);
    document.getElementById('volverMovimientosBtn').addEventListener('click', volverARegistro);

    // Cargar datos iniciales
    actualizarSaldosCuentas();
    actualizarTotales();
    actualizarTabla();
    actualizarBalance();
    actualizarTablaMovimientos();
  });

  function validarRut(rut) {
  // Formato: 8 dígitos, guion, 1 dígito o k/K
  return /^\d{7,8}-[\dkK]$/.test(rut);
}
  </script>
</body>
</html>